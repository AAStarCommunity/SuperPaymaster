#!/bin/bash

# SuperPaymaster pre-commit hook
# Runs the fast bug hunting suite before allowing a commit.

# Robust PATH setup for non-interactive shells
export PATH="$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:$HOME/.foundry/bin"

echo "üîç Running pre-commit security & test checks..."

# 1. Run Security Scan (using SDK script)
SDK_DIR="../aastar-sdk"
if [ -d "$SDK_DIR" ]; then
    (cd "$SDK_DIR" && npx tsx scripts/security-scan.ts)
    if [ $? -ne 0 ]; then
        echo "‚ùå Security check failed in SDK. Please fix leakage before committing."
        exit 1
    fi
fi

# 2. Run Fast Bug Hunting Suite
if [ -d "$SDK_DIR" ]; then
    echo "üîç Running fast bug hunting suite..."
    (cd "$SDK_DIR" && pnpm run test:fast)
    RESULT=$?
    
    if [ $RESULT -ne 0 ]; then
        echo "‚ùå Pre-commit bug hunt failed! Please fix the bugs before committing."
        exit 1
    fi
    echo "‚úÖ Pre-commit checks passed."
else
    echo "‚ö†Ô∏è  aastar-sdk directory not found. Skipping fast bug hunt."
fi

exit 0
