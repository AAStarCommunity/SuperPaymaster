# å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µè¡ŒåŠ¨è®¡åˆ’ (Security & Performance Action Plan)

æœ¬æ–‡æ¡£æ—¨åœ¨ä¸º **SuperPaymaster** å’Œ **AAStar** é¡¹ç›®æä¾›ä¸€å¥—æ ‡å‡†åŒ–çš„å®‰å…¨å®¡è®¡ä¸æ€§èƒ½ä¼˜åŒ–å·¥ä½œæµã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨ä»£ç æäº¤å‰é€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·å‘ç°å¹¶ä¿®å¤ 90% ä»¥ä¸Šçš„å®‰å…¨æ¼æ´ä¸ Gas æµªè´¹é—®é¢˜ã€‚

## ğŸ›¡ï¸ æ ¸å¿ƒå·¥ä½œæµ (The Pipeline)

æˆ‘ä»¬å°†å®‰å…¨ä¸æ€§èƒ½æ£€æŸ¥é›†æˆåˆ°å¼€å‘ç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸€ä¸ªç¯èŠ‚ï¼š

**1. ç¼–ç é˜¶æ®µ (IDE)** -> **2. æœ¬åœ°æµ‹è¯• (Local Test)** -> **3. æäº¤å‰æ‰«æ (Pre-commit)** -> **4. æŒç»­é›†æˆ (CI/CD)**

---

### Phase 1: ç¼–ç è¾…åŠ© (IDE Support)

åœ¨ç¼–å†™ä»£ç æ—¶å®æ—¶å‘ç°é—®é¢˜ï¼Œé¿å…ä½çº§é”™è¯¯ã€‚

**è¡ŒåŠ¨é¡¹:**
1.  **å®‰è£… VSCode æ’ä»¶**:
    *   **Solidity Visual Auditor**: æä¾›å®‰å…¨é«˜äº®ã€å¤æ‚é€»è¾‘å›¾ã€‚
    *   **Inline Bookmarks**: æ–¹ä¾¿æ ‡è®° `// @audit` æˆ– `// @optimize` å¾…åŠäº‹é¡¹ã€‚

---

### Phase 2: æœ¬åœ°æµ‹è¯•ä¸åŠ¨æ€åˆ†æ (Local Testing & Dynamics)

è¿™æ˜¯æœ€å…³é”®çš„é˜²çº¿ã€‚æˆ‘ä»¬ä¸ä»…è¦æµ‹è¯•"å®ƒèƒ½å·¥ä½œ"ï¼Œè¿˜è¦æµ‹è¯•"å®ƒä¸èƒ½è¢«ç ´å"ã€‚

**è¡ŒåŠ¨é¡¹:**
1.  **å•å…ƒæµ‹è¯•è¦†ç›–ç‡ (Coverage)**:
    *   ç›®æ ‡ï¼šæ ¸å¿ƒåˆçº¦ (å¦‚ Paymaster, Registry) è¦†ç›–ç‡ **> 95%**ã€‚
    *   å‘½ä»¤: `forge coverage --ir-minimum` (é¿å… Stack too deep é”™è¯¯)
2.  **æ¨¡ç³Šæµ‹è¯• (Fuzzing)**:
    *   é’ˆå¯¹èµ„é‡‘å¤„ç†é€»è¾‘ç¼–å†™ Fuzz Testã€‚
    *   **ä¸å˜é‡ (Invariants)**:
        *   Paymaster çš„ ETH ä½™é¢å¿…é¡»ç­‰äºæ‰€æœ‰ Operator çš„å­˜æ¬¾æ€»å’Œï¼ˆåŠ ä¸Šåè®®æ”¶å…¥ï¼‰ã€‚
        *   Operator çš„å­˜æ¬¾æ°¸è¿œä¸èƒ½ä¸ºè´Ÿã€‚
    *   å‘½ä»¤: `forge test --fuzz-runs 5000`
3.  **Gas å¿«ç…§ (Snapshot)**:
    *   æ¯æ¬¡ä¿®æ”¹é€»è¾‘åï¼Œç”Ÿæˆ Gas å¿«ç…§å¯¹æ¯”ã€‚
    *   å‘½ä»¤: `forge snapshot` (å°†ç”Ÿæˆ `.gas-snapshot` æ–‡ä»¶)
    *   **ä¼˜åŒ–ç›®æ ‡**: æ ¸å¿ƒè·¯å¾„ (validatePaymasterUserOp) çš„ Gas æ¶ˆè€—åº”ä¸¥æ ¼æ§åˆ¶ã€‚

---

### Phase 3: é™æ€åˆ†æä¸æ‰«æ (Static Analysis)

åœ¨æäº¤ä»£ç å‰ï¼Œä½¿ç”¨å·¥å…·æ‰«æå·²çŸ¥æ¼æ´å’Œä¼˜åŒ–ç‚¹ã€‚

#### 1. Slither (å®‰å…¨æ‰«æ)
Slither æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒæ‰«æå·¥å…·ã€‚

**å®‰è£…**: `pip3 install slither-analyzer`

**å¸¸ç”¨å‘½ä»¤**:
*   **äººç±»å¯è¯»æŠ¥å‘Š**:
    ```bash
    slither . --print human-summary
    ```
*   **è¯¦ç»†æ¼æ´æ‰«æ**:
    ```bash
    slither .
    ```
    *(æ³¨: å¦‚ç¼ºå°‘ `gas` printerï¼Œè¯·ç›´æ¥å‚è€ƒ forge snapshot ç»“æœ)*

#### 2. Aderyn (Foundry ä¸“ç²¾)
ä½œä¸º Slither çš„ç°ä»£åŒ–è¡¥å……ã€‚

**å®‰è£…**: `curl -L https://raw.githubusercontent.com/Cyfrin/aderyn/dev/cyfrinup/install | bash`

**å‘½ä»¤**:
```bash
aderyn .
```

---

### Phase 4: æ‰‹åŠ¨å®¡è®¡æ¸…å• (Manual Audit Checklist)

å·¥å…·æ— æ³•å‘ç°é€»è¾‘é”™è¯¯ï¼Œå¿…é¡»è¿›è¡Œäººå·¥å¤æ ¸ã€‚

**å®‰å…¨æ£€æŸ¥**:
- [ ] **æƒé™æ§åˆ¶**: æ‰€æœ‰çŠ¶æ€æ”¹å˜å‡½æ•°æ˜¯å¦æœ‰ `onlyOwner` æˆ– `onlyRole`?
- [ ] **é‡å…¥ä¿æŠ¤**: æ¶‰åŠ ETH å‘é€æˆ–å¤–éƒ¨è°ƒç”¨çš„å‡½æ•°æ˜¯å¦åŠ äº† `nonReentrant`?
- [ ] **å¤–éƒ¨è°ƒç”¨**: æ˜¯å¦æ£€æŸ¥äº†å¤–éƒ¨è°ƒç”¨çš„è¿”å›å€¼? (å°¤å…¶æ˜¯ä½çº§ call)
- [ ] **ç­¾åé‡æ”¾**: ç­¾åæ˜¯å¦åŒ…å« `nonce` å’Œ `chainid`?

**æ€§èƒ½ä¼˜åŒ– (Gas)**:
- [ ] **å¾ªç¯**: é¿å…åœ¨å¾ªç¯ä¸­è¯»å†™ Storageã€‚
- [ ] **å†…å­˜ vs Calldata**: å‡½æ•°å‚æ•°å°½å¯èƒ½ä½¿ç”¨ `calldata`ã€‚
- [ ] **è‡ªå®šä¹‰é”™è¯¯**: ä½¿ç”¨ `error Code()` ä»£æ›¿ `require(..., "string")`ã€‚
- [ ] **ä¸å¯å˜é‡**: æ„é€ å‡½æ•°åä¸å˜çš„å˜é‡æ˜¯å¦è®¾ä¸º `immutable`?

---

### ğŸš€ æ¯æ—¥å¼€å‘é€ŸæŸ¥è¡¨ (Cheat Sheet)

å½“ä½ å®Œæˆä¸€ä¸ªåŠŸèƒ½å¼€å‘åï¼ŒæŒ‰é¡ºåºè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

1.  `forge test` (ç¡®ä¿é€»è¾‘é€šè¿‡)
2.  `forge snapshot` (æŸ¥çœ‹ Gas å˜åŒ–)
3.  `slither .` (æ£€æŸ¥å®‰å…¨æ¼æ´)
4.  `slither . --print gas` (å¯»æ‰¾ä¼˜åŒ–ç©ºé—´)
5.  å¦‚æœä¸€åˆ‡æ­£å¸¸ -> **Git Commit**

---

### ğŸ“š èµ„æºé“¾æ¥
*   [Slither Documentation](https://github.com/crytic/slither)
*   [Foundry Book](https://book.getfoundry.sh/)
*   [Solidity Gas Optimization Tips](https://github.com/higger/solidity-gas-optimization-tips)
