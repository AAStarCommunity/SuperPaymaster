# MySBT v2.4.5 & SuperPaymaster V2.3.3 部署记录

**部署日期**: 2024-11-24
**网络**: Sepolia Testnet
**部署者**: 0x411BD567E46C0781248dbB6a9211891C032885e5

---

## 部署摘要

### MySBT v2.4.5-optimized
- **合约地址**: `0xa4eda5d023ea94a60b1d4b5695f022e1972858e7`
- **交易哈希**: `0x7520deecbee38a08edd5b004d085a621b2dfde12a1195f78d5d87138462c6009`
- **区块**: 9,696,301
- **Gas使用**: 4,592,611
- **合约大小**: 21,401 bytes（优化后，-21%）

### SuperPaymaster V2.3.3
- **合约地址**: `0x7c3c355d9aa4723402bec2a35b61137b8a10d5db`
- **交易哈希**: `0x8433036434d55fb60b4799d0ea4f55a74a024929331a8f00a8046930ac8632df`
- **区块**: 9,696,309
- **DEFAULT_SBT**: `0xa4eda5d023ea94a60b1d4b5695f022e1972858e7` ✅

---

## 合约优化记录

### 优化背景
MySBT v2.4.5原始大小为27,266 bytes，超出以太坊限制（24,576 bytes）2,690 bytes。

### 优化方案（Plan C）
1. ✅ 移除NFT绑定功能（6个函数）
2. ✅ 移除内置声誉计算（4个函数）
3. ✅ 移除声誉相关存储mapping

### 优化结果
- **原始大小**: 27,266 bytes
- **优化后**: 21,401 bytes
- **节省**: 5,865 bytes (-21%)
- **余量**: 3,175 bytes

### 功能替代方案
- **NFT Avatar**: `MySBTAvatarManager.sol`（外部扩展合约）
- **Reputation**: `MySBTReputationAccumulator.sol`（外部扩展合约）

---

## 构造函数参数

### MySBT v2.4.5
```solidity
constructor(
    address _gtoken,        // 0x99cCb70646Be7A5aeE7aF98cE853a1EA1A676DCc
    address _gtokenStaking, // 0xbEbF9b4c6a4cDB92Ac184aF211AdB13a0b9BF6c0
    address _registry,      // 0x49245E1f3c2dD99b3884ffeD410d0605Cf4dC696
    address _dao            // 0x411BD567E46C0781248dbB6a9211891C032885e5 (deployer)
)
```

### SuperPaymaster V2.3.3
```solidity
constructor(
    address _entryPoint,      // 0x0000000071727De22E5E9d8BAf0edAc6f37da032
    address _gtoken,          // 0x99cCb70646Be7A5aeE7aF98cE853a1EA1A676DCc
    address _gtokenStaking,   // 0xbEbF9b4c6a4cDB92Ac184aF211AdB13a0b9BF6c0
    address _registry,        // 0x49245E1f3c2dD99b3884ffeD410d0605Cf4dC696
    address _ethUsdPriceFeed, // 0x694AA1769357215DE4FAC081bf1f309aDC325306
    address _defaultSBT       // 0xa4eda5d023ea94a60b1d4b5695f022e1972858e7
)
```

---

## 集成配置

### 1. MySBT → SuperPaymaster
```bash
# 设置SuperPaymaster地址
cast send 0xa4eda5d023ea94a60b1d4b5695f022e1972858e7 \
  "setSuperPaymaster(address)" \
  0x7c3c355d9aa4723402bec2a35b61137b8a10d5db \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --legacy

# 交易哈希: 0xdd0358e35b90debc45e176f53dffcc86ff900bdfd2d0533afcce0797376d4d4f
# 状态: ✅ 成功
```

### 2. SuperPaymaster → MySBT
- **DEFAULT_SBT**: immutable，已在构造时设置 ✅
- **验证**: `0xa4eda5d023ea94a60b1d4b5695f022e1972858e7`

### 3. SBT Holder注册测试
```bash
# 手动注册deployer为SBT holder（tokenId=1）
cast send 0x7c3c355d9aa4723402bec2a35b61137b8a10d5db \
  "batchRegisterSBTHolders(address[],uint256[])" \
  "[0x411BD567E46C0781248dbB6a9211891C032885e5]" \
  "[1]" \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY \
  --legacy

# 交易哈希: 0xd88feb29658c818d1a5f7ef3411ce8f0d3800e4052b8eb3635fbf3ab3c089496
# 状态: ✅ 成功
# 验证: totalSBTHolders = 1
```

---

## 验证命令

### MySBT v2.4.5
```bash
forge verify-contract \
  0xa4eda5d023ea94a60b1d4b5695f022e1972858e7 \
  contracts/src/paymasters/v2/tokens/MySBT_v2_4_5.sol:MySBT_v2_4_5 \
  --chain sepolia \
  --constructor-args $(cast abi-encode \
    "constructor(address,address,address,address)" \
    0x99cCb70646Be7A5aeE7aF98cE853a1EA1A676DCc \
    0xbEbF9b4c6a4cDB92Ac184aF211AdB13a0b9BF6c0 \
    0x49245E1f3c2dD99b3884ffeD410d0605Cf4dC696 \
    0x411BD567E46C0781248dbB6a9211891C032885e5)
```

### SuperPaymaster V2.3.3
```bash
forge verify-contract \
  0x7c3c355d9aa4723402bec2a35b61137b8a10d5db \
  contracts/src/paymasters/v2/core/SuperPaymasterV2_3_3.sol:SuperPaymasterV2_3_3 \
  --chain sepolia \
  --constructor-args $(cast abi-encode \
    "constructor(address,address,address,address,address,address)" \
    0x0000000071727De22E5E9d8BAf0edAc6f37da032 \
    0x99cCb70646Be7A5aeE7aF98cE853a1EA1A676DCc \
    0xbEbF9b4c6a4cDB92Ac184aF211AdB13a0b9BF6c0 \
    0x49245E1f3c2dD99b3884ffeD410d0605Cf4dC696 \
    0x694AA1769357215DE4FAC081bf1f309aDC325306 \
    0xa4eda5d023ea94a60b1d4b5695f022e1972858e7)
```

---

## 下一步操作

### 1. 注册Operator
- 准备GT token
- 调用`registerOperatorWithAutoStake`
- 配置xPNTs token

### 2. 测试Gasless交易
- 使用SBT holder账户
- 测试ERC-20 approve操作
- 验证xPNTs扣除

### 3. 更新shared-config
- 更新MySBT ABI和地址
- 更新SuperPaymaster地址
- 发布新版本

---

## 备份文件

- **备份目录**: `backups/mysbt-v2.4.5-pre-optimization/`
- **Git Tag**: `mysbt-v2.4.5-before-optimization`
- **决策文档**: `docs/MySBT_v2.4.5_Optimization_Decision.md`

---

## Etherscan链接

- MySBT v2.4.5: https://sepolia.etherscan.io/address/0xa4eda5d023ea94a60b1d4b5695f022e1972858e7
- SuperPaymaster V2.3.3: https://sepolia.etherscan.io/address/0x7c3c355d9aa4723402bec2a35b61137b8a10d5db
