# PaymasterV4_1i éƒ¨ç½²å’Œæµ‹è¯•è®¡åˆ’

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° PaymasterV4_1iï¼ˆå·¥å‚éƒ¨ç½²ç‰ˆæœ¬ï¼‰çš„å®Œæ•´éƒ¨ç½²å’Œæµ‹è¯•æµç¨‹ã€‚

## 1. å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
- PaymasterV4Base æŠ½è±¡åŸºç±»
- PaymasterV4_1 ç›´æ¥éƒ¨ç½²ç‰ˆæœ¬ï¼ˆç»§æ‰¿ Baseï¼‰
- PaymasterV4_1i å·¥å‚éƒ¨ç½²ç‰ˆæœ¬ï¼ˆç»§æ‰¿ Base + Initializableï¼‰
- éƒ¨ç½²è„šæœ¬ï¼š`script/DeployPaymasterV4_1i.s.sol`
- æ‰€æœ‰åˆçº¦ç¼–è¯‘é€šè¿‡
- ç‰ˆæœ¬å·æµ‹è¯•ä¿®å¤

### ğŸ“¦ ç°æœ‰åŸºç¡€è®¾æ–½
- **PaymasterFactory**: å·²éƒ¨ç½²åœ¨ Sepoliaï¼ˆæ¥è‡ª shared-configï¼‰
  - ç‰ˆæœ¬ï¼šv1.0.0
  - æ”¯æŒ `addImplementation()` æ·»åŠ æ–°ç‰ˆæœ¬
  - æ”¯æŒ `deployPaymaster()` åˆ›å»ºä»£ç†å®ä¾‹
  - Gas èŠ‚çœï¼š~95%ï¼ˆä» 3-5M â†’ ~100kï¼‰

## 2. éƒ¨ç½²æµç¨‹

### æ­¥éª¤ 1: éƒ¨ç½² PaymasterV4_1i å®ç°åˆçº¦

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export SEPOLIA_RPC_URL="your_rpc_url"
export ETHERSCAN_API_KEY="your_api_key"
export PRIVATE_KEY="your_private_key"

# éƒ¨ç½²å®ç°åˆçº¦
forge script script/DeployPaymasterV4_1i.s.sol:DeployPaymasterV4_1i \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY \
  -vvvv
```

**é¢„æœŸè¾“å‡º**ï¼š
```
=== Deployment Successful ===
Implementation: 0x... (NEW ADDRESS)
Version: PaymasterV4.1i-v1.0.0
```

### æ­¥éª¤ 2: æ³¨å†Œå®ç°åˆ° PaymasterFactory

éœ€è¦ Factory owner æƒé™æ‰§è¡Œï¼š

```solidity
// è°ƒç”¨ PaymasterFactory
factory.addImplementation("v4.1i", <implementation_address>);
```

**æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°éƒ¨ç½² Factory**ï¼š
- âŒ **ä¸éœ€è¦**ï¼ç°æœ‰ Factory å·²æ”¯æŒç‰ˆæœ¬ç®¡ç†
- åªéœ€è°ƒç”¨ `addImplementation()` æ·»åŠ  v4.1i

### æ­¥éª¤ 3: æµ‹è¯•å·¥å‚éƒ¨ç½²ï¼ˆä½¿ç”¨è„šæœ¬ï¼‰

åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯å®Œæ•´æµç¨‹ï¼š

```solidity
// script/TestPaymasterV4_1i_Factory.s.sol
contract TestPaymasterV4_1i_Factory is Script {
    function run() external {
        // 1. å‡†å¤‡ initialize å‚æ•°
        bytes memory initData = abi.encodeWithSignature(
            "initialize(address,address,address,address,uint256,uint256,uint256,address,address,address,address)",
            entryPoint,
            owner,
            treasury,
            ethUsdPriceFeed,
            serviceFeeRate,
            maxGasCostCap,
            0, // minTokenBalance (compatibility)
            xpntsFactory,
            sbtAddress,
            gasTokenAddress,
            registryAddress
        );

        // 2. é€šè¿‡å·¥å‚éƒ¨ç½²
        address paymaster = factory.deployPaymaster("v4.1i", initData);

        // 3. éªŒè¯éƒ¨ç½²æˆåŠŸ
        PaymasterV4_1i instance = PaymasterV4_1i(paymaster);
        console.log("Version:", instance.version());
        console.log("Owner:", instance.owner());
        console.log("EntryPoint:", address(instance.entryPoint()));
    }
}
```

### æ­¥éª¤ 4: å‰ç«¯é›†æˆæµ‹è¯•

ä¿®æ”¹ registry å‰ç«¯ä½¿ç”¨å·¥å‚éƒ¨ç½²ï¼š

```typescript
// registry/src/features/operator/wizard/Step3_DeployPaymaster.tsx

// OLD: ç›´æ¥éƒ¨ç½²
const deployTx = await paymasterFactory.deploy(...);

// NEW: ä½¿ç”¨å·¥å‚éƒ¨ç½²
const initData = ethers.utils.defaultAbiCoder.encode(
  ['address', 'address', 'address', ...],
  [entryPoint, owner, treasury, ...]
);

const tx = await paymasterFactory.deployPaymaster("v4.1i", initData);
```

## 3. æµ‹è¯•æ¸…å•

### 3.1 åˆçº¦æµ‹è¯•

- [x] PaymasterV4Base ç¼–è¯‘é€šè¿‡
- [x] PaymasterV4_1 ç¼–è¯‘é€šè¿‡
- [x] PaymasterV4_1i ç¼–è¯‘é€šè¿‡
- [x] ç‰ˆæœ¬å·æµ‹è¯•é€šè¿‡
- [ ] åˆ›å»º PaymasterV4_1i å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯• initialize å‡½æ•°
- [ ] æµ‹è¯• registry é›†æˆ
- [ ] æµ‹è¯• EntryPoint é›†æˆ

### 3.2 éƒ¨ç½²æµ‹è¯•

- [ ] éƒ¨ç½² PaymasterV4_1i å®ç°åˆ° Sepolia
- [ ] éªŒè¯åˆçº¦åœ¨ Etherscan
- [ ] æ³¨å†Œåˆ° PaymasterFactory
- [ ] é€šè¿‡ Factory åˆ›å»ºç¬¬ä¸€ä¸ªå®ä¾‹
- [ ] éªŒè¯å®ä¾‹åŠŸèƒ½æ­£å¸¸

### 3.3 Gas å¯¹æ¯”æµ‹è¯•

| éƒ¨ç½²æ–¹å¼ | é¢„ä¼° Gas | å®é™… Gas | èŠ‚çœæ¯”ä¾‹ |
|---------|---------|---------|---------|
| ç›´æ¥éƒ¨ç½² (v4.1) | ~3-5M | TBD | - |
| å·¥å‚éƒ¨ç½² (v4.1i) | ~100k | TBD | ~95% |

### 3.4 åŠŸèƒ½æµ‹è¯•

- [ ] validatePaymasterUserOp æ­£å¸¸å·¥ä½œ
- [ ] postOp å›è°ƒæ­£å¸¸
- [ ] SBT éªŒè¯åŠŸèƒ½
- [ ] GasToken æ”¯ä»˜åŠŸèƒ½
- [ ] Registry é›†æˆï¼ˆdeactivateFromRegistryï¼‰
- [ ] Owner æƒé™ç®¡ç†

## 4. ç‰ˆæœ¬å·ç®¡ç†

### ç‰ˆæœ¬å·è§„èŒƒ

æ‰€æœ‰åˆçº¦å¿…é¡»åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼š

```solidity
// å­—ç¬¦ä¸²ç‰ˆæœ¬ï¼ˆç”¨æˆ·å¯è¯»ï¼‰
function version() external pure returns (string memory) {
    return "ContractName-vX.Y.Z";
}

// æ•°å­—ç‰ˆæœ¬ï¼ˆç”¨äºæ¯”è¾ƒï¼‰
uint256 public constant VERSION_CODE = XXYYZZ;  // X.Y.Z * 10000
```

### å½“å‰ç‰ˆæœ¬

- **PaymasterV4Base**: "PaymasterV4Base-v1.0.0"
- **PaymasterV4_1**: "PaymasterV4.1-Registry-v1.1.0"
- **PaymasterV4_1i**: "PaymasterV4.1i-v1.0.0"
- **PaymasterFactory**: VERSION_CODE = 10000 (v1.0.0)

### ç‰ˆæœ¬æ›´æ–°æµç¨‹

1. ä¿®æ”¹åˆçº¦é€»è¾‘
2. æ›´æ–° `version()` å‡½æ•°è¿”å›å€¼
3. æ›´æ–° `VERSION_CODE` å¸¸é‡
4. æ›´æ–°æµ‹è¯•ä¸­çš„ç‰ˆæœ¬å·æ–­è¨€
5. åˆ›å»º git tag: `v4.1i-v1.0.1`

## 5. å›ç­”ç”¨æˆ·é—®é¢˜

### Q1: æ˜¯å¦éœ€è¦é‡æ–°éƒ¨ç½² PaymasterFactoryï¼Ÿ

**ç­”æ¡ˆ**ï¼šâŒ **ä¸éœ€è¦**

**åŸå› **ï¼š
- ç°æœ‰ Factory å·²æ”¯æŒå¤šç‰ˆæœ¬ç®¡ç†
- é€šè¿‡ `addImplementation("v4.1i", address)` æ·»åŠ æ–°ç‰ˆæœ¬
- ä¸å½±å“å·²éƒ¨ç½²çš„ v4.1 å®ä¾‹
- å‘åå…¼å®¹

### Q2: æ˜¯å¦éœ€è¦éƒ¨ç½² v4.1i å®ä¾‹æµ‹è¯•ï¼Ÿ

**ç­”æ¡ˆ**ï¼šâœ… **éœ€è¦**

**æµ‹è¯•èŒƒå›´**ï¼š
1. **éƒ¨ç½²æµ‹è¯•**ï¼šéªŒè¯ Factory èƒ½æˆåŠŸåˆ›å»ºä»£ç†
2. **åˆå§‹åŒ–æµ‹è¯•**ï¼šéªŒè¯ initialize å‡½æ•°æ­£ç¡®è®¾ç½®æ‰€æœ‰å‚æ•°
3. **åŠŸèƒ½æµ‹è¯•**ï¼šéªŒè¯ UserOp éªŒè¯ã€postOpã€Registry é›†æˆ
4. **Gas æµ‹è¯•**ï¼šç¡®è®¤å®é™… gas èŠ‚çœè¾¾åˆ°é¢„æœŸ

**å»ºè®®æµ‹è¯•é¡ºåº**ï¼š
1. Sepolia æµ‹è¯•ç½‘éƒ¨ç½²å’Œæµ‹è¯•
2. å‰ç«¯é›†æˆæµ‹è¯•
3. å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•
4. ä¸»ç½‘éƒ¨ç½²å‰å®¡è®¡

## 6. å‰ç«¯ä¿®æ”¹

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. **Step3_DeployPaymaster.tsx**
   - æ·»åŠ éƒ¨ç½²æ–¹å¼é€‰æ‹©ï¼ˆDirect / Factoryï¼‰
   - ä¿®æ”¹éƒ¨ç½²é€»è¾‘ä½¿ç”¨ Factory
   - æ›´æ–° Gas ä¼°ç®—æ˜¾ç¤º

2. **networkConfig.ts**
   - å·²æ·»åŠ  `paymasterFactory` åœ°å€
   - ç¡®ä¿ Sepolia é…ç½®æ­£ç¡®

### æ¨è UI æ”¹è¿›

```tsx
// æ·»åŠ éƒ¨ç½²æ–¹å¼é€‰æ‹©
<RadioGroup value={deployMode} onChange={setDeployMode}>
  <Radio value="factory">
    ğŸ­ Factory Deployment (Recommended)
    <Badge>~100k gas</Badge>
  </Radio>
  <Radio value="direct">
    ğŸ”§ Direct Deployment
    <Badge>~3-5M gas</Badge>
  </Radio>
</RadioGroup>
```

## 7. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. âœ… ä¿®å¤ç‰ˆæœ¬å·æµ‹è¯•ï¼ˆå·²å®Œæˆï¼‰
2. âº éƒ¨ç½² PaymasterV4_1i å®ç°åˆ° Sepolia
3. âº æ³¨å†Œåˆ° PaymasterFactory
4. âº åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯ Factory éƒ¨ç½²

### åç»­è®¡åˆ’
5. âº å‰ç«¯é›†æˆï¼ˆregistry wizardï¼‰
6. âº å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•
7. âº æ–‡æ¡£æ›´æ–°
8. âº ä¸»ç½‘éƒ¨ç½²å‡†å¤‡

## 8. é£é™©å’Œæ³¨æ„äº‹é¡¹

### æŠ€æœ¯é£é™©
- âœ… **å·²è§£å†³**ï¼šimmutable â†’ storage å˜é‡è¿ç§»
- âœ… **å·²è§£å†³**ï¼šOwnable æ„é€ å‡½æ•°åˆå§‹åŒ–
- âš ï¸ **éœ€æ³¨æ„**ï¼šinitialize åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼ˆInitializable ä¿æŠ¤ï¼‰
- âš ï¸ **éœ€æ³¨æ„**ï¼šå®ç°åˆçº¦ç¦æ­¢åˆå§‹åŒ–ï¼ˆ_disableInitializersï¼‰

### è¿è¥é£é™©
- âš ï¸ Factory owner æƒé™ç®¡ç†
- âš ï¸ å®ç°åˆçº¦åœ°å€ä¸å¯æ›´æ”¹ï¼ˆæ·»åŠ åï¼‰
- âš ï¸ å·²éƒ¨ç½²ä»£ç†æ— æ³•å‡çº§ï¼ˆEIP-1167 ä¸å¯å‡çº§ï¼‰

## 9. å‚è€ƒèµ„æ–™

- [EIP-1167: Minimal Proxy Contract](https://eips.ethereum.org/EIPS/eip-1167)
- [OpenZeppelin Clones](https://docs.openzeppelin.com/contracts/4.x/api/proxy#Clones)
- [OpenZeppelin Initializable](https://docs.openzeppelin.com/contracts/4.x/api/proxy#Initializable)
- [v4.1i Architecture Design](./v4.1i-architecture.md)
