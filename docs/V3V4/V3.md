# SuperPaymasterV3: A Design Document for a Future-Compatible, On-Chain Gas Sponsorship Protocol

## 1. Abstract & Vision

This document outlines the architecture and design principles for SuperPaymasterV3, a purely on-chain gas sponsorship protocol. The vision is to create a solution that is not only compatible with the current ERC-4337 standard but also forward-compatible with future native account abstraction proposals like EIP-7702 and RIP-7560.

The core innovations of SuperPaymasterV3 are **AOC (All-On-Chain)** and **AOA (Asset-Oriented Abstraction)**. By eliminating off-chain server dependencies, the protocol aims to provide a more efficient, lower-cost, and decentralized gas sponsorship experience. Through AOA, it abstracts away the complexities of gas payment, offering a near-zero friction experience for both Smart Account (SA) and Externally Owned Account (EOA) users, centered around the assets they hold rather than the gas they need.

## 2. Background & Motivation

### 2.1. Current State (ERC-4337)
The current ERC-4337 standard relies on a `Paymaster` to sponsor transactions and a `Bundler` to submit `UserOperations` to the `EntryPoint` contract. This model, while functional, often involves off-chain services for paymaster validation (e.g., checking a user's eligibility off-chain and providing a signature) and settlement (e.g., off-chain invoicing for sponsored gas). This introduces centralization, potential latency, and operational costs.

### 2.2. Future State (Native Account Abstraction)
Future proposals like EIP-7702 (for L1) and RIP-7560 (for L2) aim to make Smart Accounts a native feature of the protocol. In this future, `Bundlers` as dedicated transaction submitters may become obsolete, as native accounts could initiate transactions directly. However, the need for gas payment persists. Users without the native gas token (e.g., ETH) will still require a mechanism to pay for gas with other assets (e.g., ERC20 tokens). Therefore, the `Paymaster` component remains essential.

### 2.3. The Problem Statement
SuperPaymasterV3 is designed to bridge this gap. It proposes a unified, on-chain `Paymaster` solution that works today and is architecturally prepared for the future, while innovating on the core validation and settlement logic to be more decentralized and efficient.

## 3. System Architecture & Core Principles

SuperPaymasterV3 is founded on several key principles and components:

*   **All-On-Chain (AOC)**: Eliminates the need for an off-chain Paymaster validation server. All validation logic is executed on-chain.
*   **Asset-Oriented Abstraction (AOA)**: The user's interaction is focused on their assets (e.g., holding a specific NFT or ERC20 token balance). The system uses these assets as credentials for gas sponsorship.
*   **Future-Compatibility**: Designed to support both ERC-4337 `UserOperations` and future native transaction types.
*   **Progressive Decentralization**: While starting with certain centralized components, the architecture allows for every part of the system—from account creation and key management to the paymaster and settlement process—to be progressively decentralized.

### Key Components:
1.  **Paymaster Contract (On-Chain)**: The core logic contract. It validates a user's eligibility for gas sponsorship.
2.  **Settlement Contract (On-Chain)**: Records debts for sponsored transactions and manages the settlement state.
3.  **Points Contract (On-Chain)**: A reputation and credit contract. It holds user deposits/points, allows for negative balances within a defined credit limit, and serves as a key part of the on-chain validation.
4.  **Decentralized Validator Technology (DVT) Network (Off-Chain)**: A network of off-chain actors that monitor the `Settlement Contract` and competitively bundle settlement transactions to be executed on-chain.
5.  **Gas Sponsor Market**: A conceptual marketplace where users can discover `Paymaster` contracts that support their specific ERC20 tokens for gas payment.

## 4. Core Mechanisms

The protocol operates in a two-stage process: On-Chain Validation and Off-Chain Triggered Settlement.

### 4.1. Stage 1: On-Chain Validation
This is the entry point for a user's transaction.

1.  **UserOperation Construction**:
    *   The user constructs a `UserOperation` (or future native AA transaction).
    *   **`paymaster`**: Set to the specific address of a SuperPaymasterV3 contract, discovered via the Gas Sponsor Market.
    *   **`gasPrice` fields**: Set to zero or empty. This signals an intent for sponsorship and bypasses standard bundler gas price checks.
    *   **`paymasterAndData` / `paymasterSignature`**: Left empty, as no off-chain signature is required.

2.  **Paymaster Validation (`validatePaymasterUserOp`)**:
    *   The `EntryPoint` calls the `Paymaster Contract`.
    *   The `Paymaster Contract` executes its on-chain validation logic:
        *   It checks the user's `Points Contract` balance. If the balance (even if negative) is below their established credit limit, the transaction is rejected.
        *   It verifies the user holds the required asset credential (e.g., a specific NFT or SBT).
    *   If validation passes, the `Paymaster Contract` approves the `UserOperation`. Crucially, it also logs the details of this sponsorship (user, gas cost, transaction hash) in the `Settlement Contract`, marking the debt as "unsettled".

### 4.2. Stage 2: Off-Chain Triggered Settlement
This process runs asynchronously to collect debts.

1.  **Monitoring**: The DVT network constantly monitors the `Settlement Contract` for unsettled debts.
2.  **Batching**: Once a certain threshold is met (e.g., 100 unsettled records), DVT nodes can compete to create a single, batched settlement transaction.
3.  **Execution**: The winning DVT node submits this transaction to the chain. The transaction iterates through the batch of debts and executes transfers from the users' accounts to the `Paymaster` to settle the sponsored gas fees, using the pre-approved ERC20 tokens.
4.  **Credit & Reputation**: The `Points Contract` is central to this model. It relies on a credit-based assumption: users with good reputation will not default on small gas debts (e.g., a few cents) at the risk of losing their credit and access to the system. The system can tolerate a single settlement cycle of loss per user. The `Points Contract` allows negative balances up to a limit, but a user cannot initiate new transactions if their debt exceeds this limit.

## 5. Innovations & Contributions

*   **Elimination of Off-Chain Paymaster Server**: Reduces centralization, latency, and operational cost compared to traditional ERC-4337 paymaster services.
*   **No Off-Chain Signature Validation**: Simplifies the flow and saves gas on-chain by removing the `ecrecover` step for the paymaster signature.
*   **Asset-Oriented Validation**: Provides a more user-friendly paradigm where sponsorship is based on what a user *has* (assets) rather than what they must *do* (sign extra messages).
*   **Decentralized Settlement**: Utilizes a DVT network for batch settlement, preventing centralization in the debt collection process.
*   **Credit-Based Gas Sponsorship**: Introduces a novel on-chain reputation/credit system (`Points Contract`) to underwrite small amounts of gas debt, enabling a "sponsor now, settle later" model.

---

## 6. Framework for Further Inquiry

To refine this design for product implementation and academic publication, the following areas require further detail. Please consider these questions to supplement the document.

### 6.1. On System Architecture & Scope
1.  **Target Audience & Scope**: Is SuperPaymasterV3 intended to be a public, permissionless infrastructure for any developer to use, or a core component of a specific ecosystem/application?
2.  **Multi-Chain Strategy**: How is the architecture designed to be deployed and managed across multiple L1s and L2s? Will the `Points Contract` (reputation) be chain-specific or is there a cross-chain identity consideration?

### 6.2. On the AOA / Points Contract Mechanism
3.  **Credit & Reputation System**: How is a user's initial credit limit established in the `Points Contract`? Is it based on on-chain heuristics (e.g., wallet age, transaction history, specific token holdings) or external inputs?
4.  **Sybil Resistance**: How does the reputation system defend against Sybil attacks, where an attacker creates many new accounts to abuse the initial credit allowance?
5.  **Economic Model of Points**: Are the "points" just an internal accounting unit, or do they have economic value? How are they acquired?

### 6.3. On the Settlement Process
6.  **DVT Network Incentives**: What is the incentive mechanism for the DVT nodes to monitor and submit settlement transactions? Do they receive a portion of the settled fees or a separate reward?
7.  **Settlement Failure**: What happens if a batched settlement transaction attempts to deduct funds from a user who has since transferred their ERC20 tokens away? Does the entire batch transaction revert, or does it handle individual failures gracefully? How is this failure recorded in the `Points Contract`?
8.  **Gas Oracle & Pricing**: During validation, the `Paymaster` sponsors gas. During settlement, it collects payment in ERC20 tokens. How is the exchange rate between the native gas token (e.g., ETH) and the ERC20 token determined to ensure the paymaster doesn't lose money due to price volatility between sponsorship and settlement?

### 6.4. On Security & Trust Assumptions
9.  **Liveness of DVT**: The settlement process relies on the DVT network. What are the risks if the DVT network goes offline or chooses not to process settlements? What is the maximum capital that can be locked in an "unsettled" state?
10. **Contract Security**: The `Paymaster`, `Settlement`, and `Points` contracts manage funds and credit. What are the primary attack vectors (e.g., re-entrancy, economic exploits) and the proposed mitigations?

### 6.5. On Academic Contribution
11. **Novelty Articulation**: For the PhD thesis, which specific component do you consider the most significant novel contribution? Is it the credit-based settlement mechanism, the on-chain asset-oriented validation, or the overall decentralized architecture?
12. **Formal Modeling**: Have you considered formally modeling the economic and security assumptions of the credit/reputation system? For example, proving that under certain conditions, a rational user's cost of losing reputation is higher than the benefit of defaulting on a gas payment.