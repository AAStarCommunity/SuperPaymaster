# SuperPaymaster ç‰ˆæœ¬å¯¹æ¯”ä¸å¼€å‘è®¡åˆ’

## ç‰ˆæœ¬æ¦‚è§ˆ

| ç‰ˆæœ¬ | è¯´æ˜ | PostOp Gas | æ€» Gas | vs V3åŸç‰ˆ | çŠ¶æ€ |
|------|------|-----------|--------|-----------|------|
| **V3 (Original)** | Settlement è®°è´¦,æœªä¼˜åŒ– | 266k | 426k | - | âœ… Deployed |
| **V3.0 (Optimized)** | é˜¶æ®µ1ä¼˜åŒ– | 166k | 326k | -23% | âœ… Tagged |
| **V3.1 (Stage 2)** | è¿›ä¸€æ­¥ä¼˜åŒ– | 139k | 299k | -30% | ğŸ”¨ å¼€å‘ä¸­ |
| **V3.2 (OP Mainnet)** | L2 ä¸“ç”¨ç‰ˆæœ¬ | 139k | 299k | -30% | ğŸ“‹ è®¡åˆ’ä¸­ |
| **V4 (Direct)** | ç›´æ¥è½¬è´¦,æ—  Settlement | 0 | 205k | -52% | âœ… å·²åˆ›å»º |

---

## V3.0 ä¼˜åŒ–è¯¦æƒ… (å·²å®Œæˆ) âœ…

### Git Tag: `v3.0-optimized`

### ä¼˜åŒ–å†…å®¹
1. **FeeRecord ç»“æ„ä½“**: 6 slots â†’ 4 slots
   - amount: uint256 â†’ uint96
   - timestamp: uint256 â†’ uint96
   - åˆ é™¤ settlementHash å­—æ®µ
   - **èŠ‚çœ**: -60k gas

2. **åˆ é™¤ _userRecordKeys æ˜ å°„**
   - ç§»é™¤æ•°ç»„ push æ“ä½œ
   - ä½¿ç”¨é“¾ä¸‹äº‹ä»¶ç´¢å¼•
   - **èŠ‚çœ**: -40k gas

3. **åˆ é™¤åºŸå¼ƒå‡½æ•°**
   - getUserRecordKeys()
   - getUserPendingRecords()
   - settleFeesByUsers()
   - **èŠ‚çœ**: åˆçº¦å¤§å° ~800 bytes

### Gas å¯¹æ¯”
```
ä¼˜åŒ–å‰: 426,494 gas
ä¼˜åŒ–å: 326,000 gas
èŠ‚çœ:   100,000 gas (23%)

PostOp:
ä¼˜åŒ–å‰: 266,238 gas
ä¼˜åŒ–å: 166,000 gas
èŠ‚çœ:   100,238 gas (38%)
```

---

## V3.1 ä¼˜åŒ–è®¡åˆ’ (å¼€å‘ä¸­) ğŸ”¨

### é˜¶æ®µ2ä¼˜åŒ–

#### 1. åˆ é™¤ _pendingAmounts æ˜ å°„ (-22k gas)
**å½“å‰**:
```solidity
mapping(address => mapping(address => uint256)) private _pendingAmounts;

// æ¯æ¬¡æ›´æ–°
_pendingAmounts[user][token] += amount;  // 22k gas
```

**ä¼˜åŒ–å**:
```solidity
// å®Œå…¨åˆ é™¤æ˜ å°„
// ä½¿ç”¨é“¾ä¸‹ç´¢å¼• FeeRecorded äº‹ä»¶è®¡ç®—
```

**å½±å“**:
- `getPendingBalance()` åºŸå¼ƒ (è¿”å› 0 æˆ– revert)
- å¿…é¡»ä½¿ç”¨é“¾ä¸‹ç´¢å¼•æœåŠ¡

#### 2. åˆ é™¤ _totalPending æ˜ å°„ (-5k gas)
**å½“å‰**:
```solidity
mapping(address => uint256) private _totalPending;

_totalPending[token] += amount;  // 5k gas
```

**ä¼˜åŒ–å**: å®Œå…¨åˆ é™¤,é“¾ä¸‹è®¡ç®—

#### 3. çŸ­è·¯ä¼˜åŒ– (-2k gas)
**å½“å‰**:
```solidity
require(user != address(0));
require(token != address(0));
require(amount > 0);
require(userOpHash != bytes32(0));
```

**ä¼˜åŒ–å**:
```solidity
require(
    user != address(0) && 
    token != address(0) && 
    amount > 0 &&
    userOpHash != bytes32(0),
    "Invalid params"
);
```

#### 4. Unchecked ç®—æœ¯ (-500 gas)
**åº”ç”¨ä½ç½®**: å·²éªŒè¯ä¸ä¼šæº¢å‡ºçš„åœ°æ–¹

#### 5. Event ä¼˜åŒ– (-1k gas)
**å‡å°‘ indexed å‚æ•°**: paymaster ä¸ç´¢å¼•

### é¢„æœŸæ•ˆæœ
```
V3.0:  166k PostOp gas
V3.1:  139k PostOp gas
èŠ‚çœ:  27k gas (16%)

æ€» Gas:
V3.0:  326k
V3.1:  299k
èŠ‚çœ:  27k gas (8%)
```

---

## V3.2 (OP Mainnet) è®¡åˆ’ ğŸ“‹

### ä¸»è¦è°ƒæ•´

#### 1. Gas Price å·®å¼‚
```solidity
// L1 (Sepolia): gas price ~10-100 gwei
// L2 (OP): gas price ~0.001 gwei (1000å€ä¾¿å®œ)

// è°ƒæ•´ minTokenBalance
// L1: 0.1 PNT
// L2: 0.001 PNT (æˆ–æ›´ä½)
```

#### 2. Storage æˆæœ¬
- OP Mainnet SSTORE: ~500 gas (vs L1 20k)
- V3.2 å¯ä»¥ä¿ç•™ _pendingAmounts (æˆæœ¬å¯æ¥å—)

#### 3. é…ç½®å·®å¼‚
```solidity
// V3.2 å¯é€‰è°ƒæ•´
- settlementThreshold: é™ä½ (L2 ç»“ç®—æˆæœ¬ä½)
- feeRate: å¯èƒ½è°ƒä½ (ç«äº‰å‹åŠ›)
```

### ä»£ç å·®å¼‚
- ä¸»è¦æ˜¯å‚æ•°ä¸åŒ
- æ ¸å¿ƒé€»è¾‘ç›¸åŒ
- å¯èƒ½ä¿ç•™ä¸€äº›åœ¨ L1 ä¸Šåˆ é™¤çš„åŠŸèƒ½

---

## V4 (Direct Transfer) å·²åˆ›å»º âœ…

### æ¶æ„
```
Validation Phase:
â”œâ”€ éªŒè¯ SBT
â”œâ”€ éªŒè¯ PNT ä½™é¢
â”œâ”€ è®¡ç®—è´¹ç”¨ (maxGas * rate * 1.02)
â””â”€ ç›´æ¥è½¬è´¦ PNT

PostOp Phase:
â””â”€ ä»€ä¹ˆéƒ½ä¸åš! (å·²æ”¶è´¹)
```

### ç‰¹ç‚¹
1. **æœ€ç®€å•**: æ—  Settlement,æ— è®°è´¦
2. **æœ€çœ gas**: PostOp = 0
3. **2% æº¢ä»·**: è¦†ç›–æ³¢åŠ¨ + æ‰‹ç»­è´¹
4. **æ— é€€æ¬¾**: ç®€åŒ–é€»è¾‘

### Gas å¯¹æ¯”
```
Total Gas: ~205k (vs V3 426k)
èŠ‚çœ: 221k gas (52%)

PostOp: 0 gas (vs V3 266k)
èŠ‚çœ: 266k gas (100%)
```

### é€‚ç”¨åœºæ™¯
- å°é¢é«˜é¢‘äº¤æ˜“
- å¯¹ gas æˆæœ¬æ•æ„Ÿçš„ç”¨æˆ·
- ä¸éœ€è¦ç²¾ç¡®è®¡è´¹çš„åœºæ™¯

---

## æ‰¹é‡ç»“ç®—åˆ†æç»“è®º âŒ

### ç»“è®º: ä¸æ¨è

**åŸå› **:
1. **å¹¶ä¸çœ gas**: æ‰¹é‡ç»“ç®—çœ 36%,ç›´æ¥è½¬è´¦çœ 52%
2. **å¤æ‚åº¦é«˜**: éœ€è¦é“¾ä¸‹ keeper,ç»“ç®—é€»è¾‘å¤æ‚
3. **é£é™©å¤§**: ç»“ç®—å¤±è´¥,èµ„é‡‘æµé£é™©
4. **ç”¨æˆ·ä½“éªŒå·®**: å»¶è¿Ÿç¡®è®¤,ä¸é€æ˜

### çœŸå®åº”ç”¨åœºæ™¯
åªé€‚åˆ:
- L2 â†’ L1 è·¨é“¾ç»“ç®—
- ä¼ä¸šçº§ä¿¡ç”¨æ”¯ä»˜
- Gas price å¥—åˆ© (éœ€è¦å¤æ‚åŸºç¡€è®¾æ–½)

---

## å¼€å‘ä¼˜å…ˆçº§

### ç¬¬1ä¼˜å…ˆ: V4 éƒ¨ç½²æµ‹è¯• ğŸ”¥
- æœ€å¤§ gas èŠ‚çœ (52%)
- æœ€ç®€å•å®ç°
- ç«‹å³å¯éƒ¨ç½²

**Action**:
1. ç¼–è¯‘ PaymasterV4
2. éƒ¨ç½²åˆ° Sepolia
3. å¯¹æ¯”æµ‹è¯• vs V3.0

### ç¬¬2ä¼˜å…ˆ: V3.1 å®Œæˆ
- é€‚åº¦ä¼˜åŒ– (é¢å¤– 8%)
- ä¿ç•™ Settlement çµæ´»æ€§
- é€‚åˆéœ€è¦è®°è´¦çš„åœºæ™¯

**Action**:
1. å®Œæˆ SettlementV3_1.sol
2. å®Œæˆ PaymasterV3_1.sol
3. æµ‹è¯•éªŒè¯

### ç¬¬3ä¼˜å…ˆ: V3.2 (OP)
- ç­‰ V3.1 ç¨³å®šå
- æ ¹æ® OP ç‰¹æ€§è°ƒæ•´å‚æ•°
- å¯é€‰ä¿ç•™ä¸€äº›åŠŸèƒ½

---

## æµ‹è¯•è®¡åˆ’

### å¯¹æ¯”æµ‹è¯•çŸ©é˜µ

| æµ‹è¯•åœºæ™¯ | V3.0 | V3.1 | V4 | V3.2 (OP) |
|---------|------|------|----|----|
| å•ç¬”è½¬è´¦ | âœ… | ğŸ“‹ | ğŸ“‹ | - |
| è¿ç»­10ç¬” | âœ… | ğŸ“‹ | ğŸ“‹ | - |
| Gas æ¶ˆè€— | âœ… | ğŸ“‹ | ğŸ“‹ | - |
| å¤±è´¥æ¢å¤ | âœ… | ğŸ“‹ | ğŸ“‹ | - |
| ä½™é¢æ£€æŸ¥ | âœ… | ğŸ“‹ | ğŸ“‹ | - |

### æˆæœ¬å¯¹æ¯”ç›®æ ‡

**æœŸæœ›ç»“æœ**:
```
V3.0:  326k gas (@10 gwei = $0.98)
V3.1:  299k gas (@10 gwei = $0.90) âœ… çœ8%
V4:    205k gas (@10 gwei = $0.62) âœ… çœ37%
V3.2:  299k gas (@0.001 gwei = $0.0009) âœ… L2ä¼˜åŠ¿
```

---

## æ¨èç­–ç•¥

### Sepolia æµ‹è¯•ç½‘
1. **ä¸»æ¨ V4**: æœ€ä¼˜æ€§ä»·æ¯”
2. **ä¿ç•™ V3.1**: ç‰¹æ®Šéœ€æ±‚

### Mainnet éƒ¨ç½²
- **L1**: ä¼˜å…ˆ V4,å¯é€‰ V3.1
- **L2 (OP)**: V3.2 æˆ– V4 çš†å¯

### ç”¨æˆ·é€‰æ‹©
```
å¦‚æœä½ :
- éœ€è¦ç²¾ç¡®è®°è´¦ â†’ V3.1
- éœ€è¦æ‰¹é‡ç»“ç®— â†’ V3.1
- éœ€è¦ä¿¡ç”¨æ”¯ä»˜ â†’ V3.1
- å…¶ä»–æ‰€æœ‰åœºæ™¯ â†’ V4 âœ…
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
- [ ] ç¼–è¯‘ PaymasterV4.sol
- [ ] å®Œæˆ SettlementV3_1.sol ä¼˜åŒ–
- [ ] å®Œæˆ PaymasterV3_1.sol (ç¼“å­˜ Registry)
- [ ] ç¼–è¯‘æ‰€æœ‰ç‰ˆæœ¬

### æœ¬å‘¨å®Œæˆ
- [ ] éƒ¨ç½² V4 åˆ° Sepolia
- [ ] éƒ¨ç½² V3.1 åˆ° Sepolia
- [ ] è¿è¡Œå¯¹æ¯”æµ‹è¯•
- [ ] è®°å½•å®é™… gas æ•°æ®

### ä¸‹å‘¨è®¡åˆ’
- [ ] åˆ†ææµ‹è¯•ç»“æœ
- [ ] å†³å®š Mainnet éƒ¨ç½²ç­–ç•¥
- [ ] å‡†å¤‡ OP Mainnet ç‰ˆæœ¬
- [ ] æ–‡æ¡£æ›´æ–°

---

## é™„å½•: Gas ä¼˜åŒ–æŠ€æœ¯æ€»ç»“

### å·²åº”ç”¨ âœ…
1. Bit Packing (uint256 â†’ uint96)
2. åˆ é™¤å†—ä½™æ˜ å°„ (_userRecordKeys)
3. åˆ é™¤æœªä½¿ç”¨å­—æ®µ (settlementHash)
4. é“¾ä¸‹ç´¢å¼•æ›¿ä»£é“¾ä¸ŠæŸ¥è¯¢

### V3.1 æ–°å¢ âœ…
5. åˆ é™¤ç´¢å¼•æ˜ å°„ (_pendingAmounts, _totalPending)
6. çŸ­è·¯ä¼˜åŒ– (åˆå¹¶ require)
7. Unchecked ç®—æœ¯
8. Event å‚æ•°ä¼˜åŒ–

### V4 æè‡´ä¼˜åŒ– âœ…
9. ç§»é™¤ Settlement ä¾èµ–
10. PostOp ç©ºå®ç°
11. é¢„ä»˜è´¹æ¨¡å¼

### æœªåº”ç”¨ (å¯é€‰)
- Transient Storage (EIP-1153) - éœ€ Solidity 0.8.24+
- Assembly ä¼˜åŒ– - å¤æ‚åº¦é«˜
- Proxy æ¨¡å¼ - å¢åŠ è°ƒç”¨æˆæœ¬
