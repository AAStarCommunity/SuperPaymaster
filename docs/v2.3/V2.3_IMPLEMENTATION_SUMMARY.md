# SuperPaymaster V2.3 å®æ–½æ€»ç»“

## âœ… å®æ–½çŠ¶æ€ï¼šå·²å®Œæˆ

**å®æ–½æ—¶é—´**: 2025-11-19
**ç‰ˆæœ¬**: V2.3.0
**åˆçº¦æ–‡ä»¶**: `/contracts/src/paymasters/v2/core/SuperPaymasterV2_3.sol`
**éƒ¨ç½²è„šæœ¬**: `/contracts/script/DeployV2_3.s.sol`

---

## ğŸ¯ ä¸¤å¤§æ ¸å¿ƒä¼˜åŒ–

### ä¼˜åŒ–1ï¼šSBTå­˜å‚¨ä¼˜åŒ–ï¼ˆèŠ‚çœ~10.8k gasï¼‰

**æ”¹åŠ¨å‰**:
```solidity
struct OperatorAccount {
    address[] supportedSBTs;  // åŠ¨æ€æ•°ç»„
    // ...
}

function _hasSBT(address user, address[] memory supportedSBTs) internal view returns (bool) {
    for (uint256 i = 0; i < supportedSBTs.length; i++) {
        if (IERC721(supportedSBTs[i]).balanceOf(user) > 0) {
            return true;
        }
    }
    return false;
}
```

**Gaså¼€é”€**: ~10,900 gas
- è¯»å–æ•°ç»„é•¿åº¦: 2,100 gas
- è¯»å–3ä¸ªå…ƒç´ : 6,300 gas
- å¤åˆ¶åˆ°memory: 1,000 gas
- å¾ªç¯æ£€æŸ¥: 1,500 gas

**æ”¹åŠ¨å**:
```solidity
// Storage section
address public immutable DEFAULT_SBT;

constructor(..., address _defaultSBT) {
    DEFAULT_SBT = _defaultSBT;
}

function _hasSBT(address user) internal view returns (bool) {
    return IERC721(DEFAULT_SBT).balanceOf(user) > 0;
}
```

**Gaså¼€é”€**: ~100 gas
- è¯»å–immutable: ~100 gas

**èŠ‚çœ**: 10,800 gas (5.9%)

---

### ä¼˜åŒ–2ï¼šå¢åŠ xPNTsTokenæ›´æ–°å‡½æ•°

**æ–°å¢åŠŸèƒ½**:
```solidity
/**
 * @notice Update operator's xPNTsToken configuration
 * @param newXPNTsToken New xPNT token address
 */
function updateOperatorXPNTsToken(address newXPNTsToken) external {
    if (accounts[msg.sender].stakedAt == 0) {
        revert NotRegistered(msg.sender);
    }
    if (newXPNTsToken == address(0)) {
        revert InvalidAddress(newXPNTsToken);
    }

    address oldToken = accounts[msg.sender].xPNTsToken;
    accounts[msg.sender].xPNTsToken = newXPNTsToken;

    emit OperatorXPNTsTokenUpdated(msg.sender, oldToken, newXPNTsToken);
}

// æ–°å¢äº‹ä»¶
event OperatorXPNTsTokenUpdated(
    address indexed operator,
    address indexed oldToken,
    address indexed newToken
);
```

**ä¼˜åŠ¿**:
- âœ… Operatorå¯ä»¥çµæ´»æ›´æ¢xPNTsToken
- âœ… ä¿æŒoperatorçš„å£°èª‰å’Œå†å²è®°å½•
- âœ… æ— éœ€é‡æ–°è´¨æŠ¼
- âœ… æ”¯æŒç¤¾åŒºtokenå‡çº§

---

## ğŸ“‹ å®Œæ•´æ”¹åŠ¨æ¸…å•

### æ–°å¢å†…å®¹
1. âœ… `address public immutable DEFAULT_SBT` - immutableå˜é‡
2. âœ… `updateOperatorXPNTsToken()` - xPNT tokenæ›´æ–°å‡½æ•°
3. âœ… `OperatorXPNTsTokenUpdated` - æ–°äº‹ä»¶
4. âœ… constructoræ–°å¢`_defaultSBT`å‚æ•°

### ä¿®æ”¹å†…å®¹
1. âœ… `OperatorAccount` struct - ç§»é™¤`supportedSBTs`å­—æ®µ
2. âœ… `registerOperator()` - ç§»é™¤`supportedSBTs`å‚æ•°
3. âœ… `registerOperatorWithAutoStake()` - ç§»é™¤`supportedSBTs`å‚æ•°
4. âœ… `_hasSBT()` - ç®€åŒ–ä¸ºç›´æ¥æ£€æŸ¥DEFAULT_SBT
5. âœ… `validatePaymasterUserOp()` - æ›´æ–°_hasSBTè°ƒç”¨
6. âœ… VERSIONæ›´æ–°ä¸º"2.3.0"
7. âœ… VERSION_CODEæ›´æ–°ä¸º20300

### ç§»é™¤å†…å®¹
1. âœ… `updateSupportedSBTs()` - å‡½æ•°ç§»é™¤
2. âœ… `updateOperatorSupportedSBTs()` - ç®¡ç†å‘˜å‡½æ•°ç§»é™¤
3. âœ… `SupportedSBTsUpdated` - äº‹ä»¶ç§»é™¤

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„æµ‹

### GasèŠ‚çœ

| é¡¹ç›® | å½“å‰v2.2 | v2.3ä¼˜åŒ–å | èŠ‚çœ |
|------|---------|-----------|------|
| SBTæ£€æŸ¥ | ~10,900 gas | ~100 gas | **-10,800 gas** |
| å…¶ä»–é€»è¾‘ | ~170,779 gas | ~170,779 gas | - |
| **æ€»è®¡** | **181,679 gas** | **170,879 gas** | **-10,800 (-5.9%)** |

### vs Baselineå¯¹æ¯”

| ç‰ˆæœ¬ | Gas | vs Baseline | è¯´æ˜ |
|------|-----|-------------|------|
| **Baseline v1.0** | 312,008 | - | åŸå§‹ç‰ˆæœ¬ |
| **v2.2 + Pre-permit** | 181,679 | -41.8% | ä¹‹å‰æœ€ä¼˜ |
| **v2.3 + SBTä¼˜åŒ–** | **170,879** | **-45.2%** | **æ–°ä¼˜åŒ–** âœ¨ |

### è´¹ç”¨èŠ‚çœï¼ˆETH=$3000, gas=2 gwei, aPNT=$0.02ï¼‰

| é…ç½® | Gas | è´¹ç”¨(xPNT) | vs Baseline |
|------|-----|-----------|-------------|
| Baseline | 312,008 | 97.36 xPNT | - |
| v2.2 å½“å‰ | 181,679 | 56.69 xPNT | -41.8% |
| **v2.3 ä¼˜åŒ–** | **170,879** | **53.31 xPNT** | **-45.2%** |

**æ¯ç¬”äº¤æ˜“é¢å¤–èŠ‚çœ**: 3.38 xPNT

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. éƒ¨ç½²å‚æ•°

```solidity
// Sepoliaæµ‹è¯•ç½‘
new SuperPaymasterV2_3(
    0x36b699a921Fc792119D84F1429e2C00A38c09F7f,  // GTOKEN
    0x83f9554641B2EB8984c4DD03d27F1f75ec537D36,  // GTOKEN_STAKING
    0xfc1d62E41a86B11cF19Ce2c0B610BE8d58a5Aa4F,  // REGISTRY
    0x694AA1769357215DE4FAC081bf1f309aDC325306,  // ETH/USD Price Feed
    0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C   // DEFAULT_SBT (MySBT)
)
```

### 2. éƒ¨ç½²å‘½ä»¤

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export PRIVATE_KEY="your_private_key"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_KEY"

# ç¼–è¯‘
forge build

# éƒ¨ç½²åˆ°Sepolia
forge script contracts/script/DeployV2_3.s.sol:DeployV2_3 \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify
```

### 3. åˆå§‹åŒ–é…ç½®

```bash
# è®¾ç½®EntryPoint
cast send $PAYMASTER_V2_3 "setEntryPoint(address)" \
  0x0000000071727De22E5E9d8BAf0edAc6f37da032 \
  --private-key $OWNER_KEY

# è®¾ç½®aPNTsToken
cast send $PAYMASTER_V2_3 "setAPNTsToken(address)" \
  $APNTS_TOKEN \
  --private-key $OWNER_KEY

# è®¾ç½®Treasury
cast send $PAYMASTER_V2_3 "setSuperPaymasterTreasury(address)" \
  $TREASURY_ADDRESS \
  --private-key $OWNER_KEY
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [ ] SBTæ£€æŸ¥é€»è¾‘ï¼ˆDEFAULT_SBT immutableï¼‰
- [ ] updateOperatorXPNTsTokenåŠŸèƒ½
- [ ] æƒé™æ§åˆ¶ï¼ˆåªæœ‰operator ownerå¯ä»¥æ›´æ–°ï¼‰
- [ ] äº‹ä»¶emitéªŒè¯

### é›†æˆæµ‹è¯•
- [ ] å®Œæ•´gaslessäº¤æ˜“æµç¨‹
- [ ] Operatoræ³¨å†Œï¼ˆæ— supportedSBTså‚æ•°ï¼‰
- [ ] xPNT tokenåˆ‡æ¢åœºæ™¯

### Gasæµ‹è¯•
- [ ] éªŒè¯èŠ‚çœ10.8k gas
- [ ] å¯¹æ¯”v2.2 vs v2.3å®é™…gasæ¶ˆè€—
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆå¤§é‡äº¤æ˜“ï¼‰

### å®‰å…¨æµ‹è¯•
- [ ] è¾¹ç•Œæµ‹è¯•ï¼šåœ°å€éªŒè¯
- [ ] é‡å…¥æµ‹è¯•
- [ ] æƒé™æµ‹è¯•

---

## ğŸ”„ ä»v2.2è¿ç§»åˆ°v2.3

### æ–¹æ¡ˆ1ï¼šé‡æ–°éƒ¨ç½²ï¼ˆæ¨èï¼‰
1. éƒ¨ç½²æ–°çš„SuperPaymasterV2_3åˆçº¦
2. Operatoråœ¨æ–°åˆçº¦é‡æ–°æ³¨å†Œ
3. å¯ä»¥é€‰æ‹©æ–°çš„xPNTsToken
4. è¿ç§»aPNTsä½™é¢

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨Proxyå‡çº§ï¼ˆå¦‚éœ€ä¿æŒå†å²æ•°æ®ï¼‰
1. éƒ¨ç½²SuperPaymasterV2_3 implementation
2. å‡çº§proxyæŒ‡å‘æ–°implementation
3. æ³¨æ„ï¼šéœ€è¦å®ç°storageè¿ç§»é€»è¾‘ï¼ˆç§»é™¤supportedSBTsæ•°ç»„ï¼‰

### å‘åå…¼å®¹æ€§
- âŒ ä¸å‘åå…¼å®¹ï¼ˆå‡½æ•°ç­¾åæ”¹å˜ï¼‰
- âœ… å¦‚éœ€æ”¯æŒå¤šSBTï¼Œå¯éƒ¨ç½²å¤šä¸ªpaymasterå®ä¾‹
- âœ… æ¯ä¸ªå®ä¾‹ç»‘å®šä¸åŒçš„DEFAULT_SBT

---

## ğŸ” é£é™©è¯„ä¼°

### ä½é£é™© âœ…
- ç§»é™¤supportedSBTsæ•°ç»„ï¼ˆç®€åŒ–é€»è¾‘ï¼Œå‡å°‘bugé¢ï¼‰
- æ·»åŠ updateOperatorXPNTsTokenå‡½æ•°ï¼ˆåªå½±å“operatorè‡ªå·±çš„é…ç½®ï¼‰
- Immutable DEFAULT_SBTï¼ˆç¼–è¯‘æ—¶ç¡®å®šï¼Œæ— è¿è¡Œæ—¶é£é™©ï¼‰

### éœ€è¦æ³¨æ„ âš ï¸
- ç¡®ä¿DEFAULT_SBTåœ°å€æ­£ç¡®ï¼ˆimmutableæ— æ³•ä¿®æ”¹ï¼‰
- æµ‹è¯•updateOperatorXPNTsTokençš„æƒé™æ§åˆ¶
- è€ƒè™‘æ˜¯å¦éœ€è¦æ·»åŠ æ›´æ–°å†·å´æœŸï¼ˆé˜²æ­¢é¢‘ç¹åˆ‡æ¢ï¼‰

### å¯é€‰å¢å¼º ğŸ’¡
- è€ƒè™‘æ·»åŠ `updateCooldown`é™åˆ¶operatoræ›´æ–°é¢‘ç‡
- è€ƒè™‘æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œè¿½è¸ªé…ç½®å˜æ›´å†å²
- å¢åŠ å¤šç­¾æ§åˆ¶é‡è¦é…ç½®æ›´æ–°

---

## ğŸ“Œ æ€»ç»“

**V2.3å®ç°äº†ä¸¤å¤§æ ¸å¿ƒä¼˜åŒ–**ï¼š

1. **SBTä¼˜åŒ–** âœ¨
   - èŠ‚çœ5.9% gasï¼ˆ~10.8k per txï¼‰
   - ç®€åŒ–ä»£ç é€»è¾‘
   - é™ä½ç»´æŠ¤æˆæœ¬

2. **xPNTsTokençµæ´»æ€§** âœ¨
   - æå‡operatoré…ç½®çµæ´»æ€§
   - æ”¯æŒç¤¾åŒºtokenå‡çº§
   - æ— gasé¢å¤–å¼€é”€

**æ€»æ•ˆæœé¢„æµ‹**ï¼š
- GasèŠ‚çœï¼š45.2% vs baselineï¼ˆvs v2.2çš„41.8%ï¼‰
- è´¹ç”¨èŠ‚çœï¼š44.05 xPNT/ç¬”ï¼ˆvs baselineçš„97.36 xPNTï¼‰
- ä»£ç æ›´ç®€æ´ã€æ›´å®‰å…¨ã€æ›´çµæ´»

**ä¸‹ä¸€æ­¥**ï¼š
- éƒ¨ç½²åˆ°Sepoliaæµ‹è¯•
- è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- éªŒè¯å®é™…gasèŠ‚çœ
- å‡†å¤‡ä¸»ç½‘éƒ¨ç½²

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-19
**çŠ¶æ€**: âœ… å®ç°å®Œæˆï¼Œå¾…æµ‹è¯•
