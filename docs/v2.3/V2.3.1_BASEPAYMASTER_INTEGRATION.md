# SuperPaymasterV2_3.1 - BasePaymaster é›†æˆå®Œæˆ

## âœ… å®Œæˆçš„ä¿®æ”¹

### 1. åˆ›å»º BasePaymaster åŸºç±»
**æ–‡ä»¶**: `contracts/src/paymasters/v2/core/BasePaymaster.sol`

**æä¾›çš„åŠŸèƒ½**:
- `deposit()` - å‘ EntryPoint å­˜å…¥ ETH
- `withdrawTo(address, uint256)` - ä» EntryPoint æå– ETH
- `addStake(uint32)` - å‘ EntryPoint æ·»åŠ è´¨æŠ¼
- `unlockStake()` - è§£é”è´¨æŠ¼
- `withdrawStake(address)` - æå–è´¨æŠ¼
- `getDeposit()` - æŸ¥è¯¢ EntryPoint ä½™é¢
- `immutable entryPoint` - ä¸å¯å˜çš„ EntryPoint å¼•ç”¨
- `onlyEntryPoint` modifier - è®¿é—®æ§åˆ¶

### 2. ä¿®æ”¹ SuperPaymasterV2_3 ç»§æ‰¿ BasePaymaster
**æ–‡ä»¶**: `contracts/src/paymasters/v2/core/SuperPaymasterV2_3.sol`

**ä¸»è¦æ”¹åŠ¨**:
- âœ… ç»§æ‰¿ `BasePaymaster` è€Œä¸æ˜¯ `Ownable`
- âœ… ç§»é™¤ `ENTRY_POINT` å˜é‡ï¼ˆä½¿ç”¨ç»§æ‰¿çš„ immutable entryPointï¼‰
- âœ… æ„é€ å‡½æ•°æ¥å— `_entryPoint` å‚æ•°å¹¶ä¼ é€’ç»™ BasePaymaster
- âœ… ç§»é™¤ `setEntryPoint()` å‡½æ•°ï¼ˆentryPoint ç°åœ¨æ˜¯ immutableï¼‰
- âœ… `validatePaymasterUserOp` ä½¿ç”¨ `override onlyEntryPoint`
- âœ… `postOp` ä½¿ç”¨ `override onlyEntryPoint`
- âœ… ç‰ˆæœ¬å‡çº§: `2.3.0` â†’ `2.3.1`

### 3. æ·»åŠ  IEntryPoint æ¥å£
**æ–‡ä»¶**: `contracts/src/paymasters/v2/interfaces/Interfaces.sol`

**æ–°å¢æ¥å£**:
```solidity
interface IEntryPoint {
    function depositTo(address account) external payable;
    function withdrawTo(address payable withdrawAddress, uint256 withdrawAmount) external;
    function addStake(uint32 unstakeDelaySec) external payable;
    function unlockStake() external;
    function withdrawStake(address payable withdrawAddress) external;
    function balanceOf(address account) external view returns (uint256);
}
```

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

### Before (V2.3.0)
```solidity
contract SuperPaymasterV2_3 is Ownable, ReentrancyGuard, IPaymaster {
    address public ENTRY_POINT; // Mutable
    
    function setEntryPoint(address _entryPoint) external onlyOwner {
        ENTRY_POINT = _entryPoint;
    }
    
    // âŒ ç¼ºå°‘ deposit/withdraw å‡½æ•°
    // âŒ æ— æ³•ç»™ EntryPoint å……å€¼ ETH
}
```

### After (V2.3.1)
```solidity
contract SuperPaymasterV2_3 is BasePaymaster, ReentrancyGuard {
    // immutable entryPoint (inherited from BasePaymaster)
    
    // âœ… deposit() - å‘ EntryPoint å­˜å…¥ ETH
    // âœ… withdrawTo() - ä» EntryPoint æå– ETH
    // âœ… addStake() - è´¨æŠ¼ç®¡ç†
    // âœ… getDeposit() - æŸ¥è¯¢ä½™é¢
}
```

## ğŸ¯ æ–°å¢åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹

### ç»™ Paymaster å……å€¼ ETH
```solidity
// Owner è°ƒç”¨
paymaster.deposit{value: 0.1 ether}();
```

```bash
# ä½¿ç”¨ cast
cast send <PAYMASTER> "deposit()" --value 0.1ether --private-key $PRIVATE_KEY --rpc-url $SEPOLIA_RPC_URL
```

### æŸ¥è¯¢ä½™é¢
```solidity
uint256 balance = paymaster.getDeposit();
```

```bash
# ä½¿ç”¨ cast
cast call <PAYMASTER> "getDeposit()(uint256)" --rpc-url $SEPOLIA_RPC_URL
```

### æå– ETH
```solidity
paymaster.withdrawTo(payable(recipient), amount);
```

## ğŸ”¥ Gas èŠ‚çœ

V2.3.1 ç›¸æ¯” V2.3.0:
- âœ… ä½¿ç”¨ immutable entryPoint (èŠ‚çœ SLOAD ~2100 gas)
- âœ… ç§»é™¤ setEntryPoint å‡½æ•° (ç®€åŒ–ä»£ç )
- âœ… æ ‡å‡†åŒ–ä»£ç ç»“æ„ (æé«˜å¯ç»´æŠ¤æ€§)

## âœ… ç¼–è¯‘çŠ¶æ€
- **ç¼–è¯‘**: âœ… æˆåŠŸ
- **è­¦å‘Š**: åªæœ‰ linting å»ºè®® (named-struct-fields)
- **æµ‹è¯•**: éœ€è¦éƒ¨ç½²åéªŒè¯

## ğŸ“ éƒ¨ç½²å‚æ•°

### V2.3.1 æ„é€ å‡½æ•°
```solidity
constructor(
    address _entryPoint,      // æ–°å¢: EntryPoint åœ°å€
    address _gtoken,
    address _gtokenStaking,
    address _registry,
    address _ethUsdPriceFeed,
    address _defaultSBT
)
```

### Sepolia Testnet åœ°å€
```
EntryPoint:      0x0000000071727De22E5E9d8BAf0edAc6f37da032
GToken:          0x99cCb70646Be7A5aeE7aF98cE853a1EA1A676DCc
GTokenStaking:   0xbEbF9b4c6a4cDB92Ac184aF211AdB13a0b9BF6c0
Registry:        0x49245E1f3c2dD99b3884ffeD410d0605Cf4dC696
EthUsdPriceFeed: 0x694AA1769357215DE4FAC081bf1f309aDC325306
DefaultSBT:      0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C
```

## ğŸš€ ä¸‹ä¸€æ­¥

1. éƒ¨ç½² SuperPaymasterV2_3.1 åˆ° Sepolia
2. æµ‹è¯• deposit() åŠŸèƒ½
3. é…ç½® locker (configureLocker)
4. æ³¨å†Œ operator
5. æµ‹è¯• gasless äº¤æ˜“
6. éªŒè¯ gas èŠ‚çœæ•ˆæœ
