# SuperPaymaster V2.3 éƒ¨ç½²å’Œæµ‹è¯•æŒ‡å—

**ç‰ˆæœ¬**: V2.3.0
**æ—¥æœŸ**: 2025-11-19
**Gasä¼˜åŒ–**: -45.2% vs baseline

---

## âœ… ç¼–è¯‘å’Œæµ‹è¯•çŠ¶æ€

### ç¼–è¯‘ç»“æœ
```bash
forge build
# âœ… Compiler run successful!
```

### æµ‹è¯•ç»“æœ
```bash
forge test --match-path "contracts/test/SuperPaymasterV2.t.sol"
# âœ… 16 tests passed, 0 failed
```

---

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. ç¯å¢ƒå˜é‡è®¾ç½®

```bash
# åŠ è½½ç¯å¢ƒå˜é‡
source /Volumes/UltraDisk/Dev2/aastar/env/.env

# æˆ–è€…æ‰‹åŠ¨è®¾ç½®
export PRIVATE_KEY="your_private_key_here"
export SEPOLIA_RPC_URL="https://sepolia.infura.io/v3/YOUR_KEY"
```

### 2. éƒ¨ç½²å‚æ•° (Sepolia)

| å‚æ•° | åœ°å€ | è¯´æ˜ |
|------|------|------|
| **GTOKEN** | `0x36b699a921Fc792119D84F1429e2C00A38c09F7f` | GToken ERC20 |
| **GTOKEN_STAKING** | `0x83f9554641B2EB8984c4DD03d27F1f75ec537D36` | GTokenStaking |
| **REGISTRY** | `0xfc1d62E41a86B11cF19Ce2c0B610BE8d58a5Aa4F` | Registry v2.2.1 |
| **ETH_USD_FEED** | `0x694AA1769357215DE4FAC081bf1f309aDC325306` | Chainlink Sepolia |
| **DEFAULT_SBT** | `0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C` | MySBT |

---

## ğŸš€ æ­¥éª¤1: éƒ¨ç½²SuperPaymasterV2_3

### éƒ¨ç½²å‘½ä»¤

```bash
forge script contracts/script/DeployV2_3.s.sol:DeployV2_3 \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify \
  --legacy \
  -vvvv
```

### é¢„æœŸè¾“å‡º

```
SuperPaymasterV2_3 deployed at: 0x...
DEFAULT_SBT: 0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C
VERSION: 2.3.0
```

### è®°å½•éƒ¨ç½²åœ°å€

```bash
# ä¿å­˜éƒ¨ç½²åœ°å€
export PAYMASTER_V2_3="0x..."  # æ›¿æ¢ä¸ºå®é™…éƒ¨ç½²åœ°å€
```

---

## âš™ï¸ æ­¥éª¤2: é…ç½®SuperPaymaster

### 2.1 è®¾ç½®EntryPoint

```bash
cast send $PAYMASTER_V2_3 \
  "setEntryPoint(address)" \
  0x0000000071727De22E5E9d8BAf0edAc6f37da032 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

### 2.2 è®¾ç½®aPNTsToken

```bash
cast send $PAYMASTER_V2_3 \
  "setAPNTsToken(address)" \
  0xBD0710596010a157B88cd141d797E8Ad4bb2306b \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

### 2.3 è®¾ç½®Treasury

```bash
cast send $PAYMASTER_V2_3 \
  "setSuperPaymasterTreasury(address)" \
  0x411BD567E46C0781248dbB6a9211891C032885e5 \
  --private-key $PRIVATE_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

### 2.4 éªŒè¯é…ç½®

```bash
# æ£€æŸ¥EntryPoint
cast call $PAYMASTER_V2_3 "ENTRY_POINT()(address)" --rpc-url $SEPOLIA_RPC_URL

# æ£€æŸ¥aPNTsToken
cast call $PAYMASTER_V2_3 "aPNTsToken()(address)" --rpc-url $SEPOLIA_RPC_URL

# æ£€æŸ¥DEFAULT_SBT
cast call $PAYMASTER_V2_3 "DEFAULT_SBT()(address)" --rpc-url $SEPOLIA_RPC_URL

# æ£€æŸ¥VERSION
cast call $PAYMASTER_V2_3 "VERSION()(string)" --rpc-url $SEPOLIA_RPC_URL
```

---

## ğŸ‘¤ æ­¥éª¤3: æ³¨å†ŒOperator (ä½¿ç”¨bPNT)

### 3.1 å‡†å¤‡å·¥ä½œ

**Operatoråœ°å€**: `0x411BD567E46C0781248dbB6a9211891C032885e5`
**bPNT Token**: `0x70Da2c1B7Fcf471247Bc3B09f8927a4ab1751Ba3` (Bread Points)

### 3.2 Approve GT Token

```bash
# Operatoréœ€è¦approve GTç»™GTokenStaking
export OPERATOR_KEY="your_operator_private_key"

cast send 0x36b699a921Fc792119D84F1429e2C00A38c09F7f \
  "approve(address,uint256)" \
  0x83f9554641B2EB8984c4DD03d27F1f75ec537D36 \
  100000000000000000000 \
  --private-key $OPERATOR_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

### 3.3 Stake GT

```bash
# Stake 30 GT
cast send 0x83f9554641B2EB8984c4DD03d27F1f75ec537D36 \
  "stake(uint256)" \
  30000000000000000000 \
  --private-key $OPERATOR_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

### 3.4 æ³¨å†ŒOperator (ä½¿ç”¨bPNT)

```bash
# âš¡ V2.3: ä¸å†éœ€è¦supportedSBTså‚æ•°
cast send $PAYMASTER_V2_3 \
  "registerOperator(uint256,address,address)" \
  30000000000000000000 \
  0x70Da2c1B7Fcf471247Bc3B09f8927a4ab1751Ba3 \
  0x411BD567E46C0781248dbB6a9211891C032885e5 \
  --private-key $OPERATOR_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

**å‚æ•°è¯´æ˜**:
- `30000000000000000000` - 30 GT (stGTokenAmount)
- `0x70Da2c1B7Fcf471247Bc3B09f8927a4ab1751Ba3` - bPNT token (xPNTsToken)
- `0x411BD567E46C0781248dbB6a9211891C032885e5` - Treasuryåœ°å€

### 3.5 éªŒè¯æ³¨å†Œ

```bash
# æŸ¥çœ‹operatorè´¦æˆ·ä¿¡æ¯
cast call $PAYMASTER_V2_3 \
  "getOperatorAccount(address)" \
  0x411BD567E46C0781248dbB6a9211891C032885e5 \
  --rpc-url $SEPOLIA_RPC_URL
```

---

## ğŸ§ª æ­¥éª¤4: æµ‹è¯•updateOperatorXPNTsTokenåŠŸèƒ½

### 4.1 æŸ¥çœ‹å½“å‰xPNTsToken

```bash
cast call $PAYMASTER_V2_3 \
  "getOperatorAccount(address)" \
  0x411BD567E46C0781248dbB6a9211891C032885e5 \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.2 æ›´æ–°xPNTsToken (bPNT â†’ å…¶ä»–token)

å‡è®¾æˆ‘ä»¬æƒ³åˆ‡æ¢åˆ°å¦ä¸€ä¸ªtoken:

```bash
# âš¡ V2.3æ–°åŠŸèƒ½: updateOperatorXPNTsToken
cast send $PAYMASTER_V2_3 \
  "updateOperatorXPNTsToken(address)" \
  0xfb56CB85C9a214328789D3C92a496d6AA185e3d3 \
  --private-key $OPERATOR_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

### 4.3 éªŒè¯æ›´æ–°

```bash
# å†æ¬¡æŸ¥çœ‹ï¼Œç¡®è®¤xPNTsTokenå·²æ›´æ–°
cast call $PAYMASTER_V2_3 \
  "getOperatorAccount(address)" \
  0x411BD567E46C0781248dbB6a9211891C032885e5 \
  --rpc-url $SEPOLIA_RPC_URL
```

### 4.4 ç›‘å¬äº‹ä»¶

```bash
# æŸ¥çœ‹OperatorXPNTsTokenUpdatedäº‹ä»¶
cast logs --address $PAYMASTER_V2_3 \
  --rpc-url $SEPOLIA_RPC_URL \
  --from-block latest
```

---

## ğŸ’¨ æ­¥éª¤5: Gaslessäº¤æ˜“æµ‹è¯•

### 5.1 å‡†å¤‡æµ‹è¯•è„šæœ¬

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `scripts/gasless-test/test-v2.3-gas-savings.js`:

```javascript
const { createPublicClient, createWalletClient, http, parseEther } = require('viem');
const { sepolia } = require('viem/chains');
const { privateKeyToAccount } = require('viem/accounts');

// é…ç½®
const PAYMASTER_V2_3 = process.env.PAYMASTER_V2_3;
const OPERATOR = "0x411BD567E46C0781248dbB6a9211891C032885e5";
const USER_PRIVATE_KEY = process.env.USER_PRIVATE_KEY;
const RPC_URL = process.env.SEPOLIA_RPC_URL;

// EntryPoint v0.7
const ENTRYPOINT = "0x0000000071727De22E5E9d8BAf0edAc6f37da032";

async function testGasSavings() {
  const account = privateKeyToAccount(USER_PRIVATE_KEY);

  // æ„å»ºUserOperation
  const userOp = {
    sender: account.address,
    nonce: 0n,
    callData: "0x...", // ERC20 transfer calldata
    accountGasLimits: packAccountGasLimits(
      30000n,  // âš¡ V2.3ä¼˜åŒ–åçš„verificationGas
      100000n  // callGas
    ),
    preVerificationGas: 50000n,
    gasFees: packGasFees(2000000000n, 2000000000n),
    paymasterAndData: encodePaymasterData(PAYMASTER_V2_3, OPERATOR),
    signature: "0x"
  };

  // ç­¾å
  const userOpHash = await getU serOpHash(userOp);
  const signature = await account.signMessage({ message: { raw: userOpHash } });
  userOp.signature = signature;

  // æäº¤åˆ°EntryPoint
  const receipt = await submitUserOp(userOp);

  console.log("âœ… Gaslessäº¤æ˜“æˆåŠŸ!");
  console.log("Gas used:", receipt.gasUsed);
  console.log("é¢„æœŸèŠ‚çœ: ~10.8k gas (vs v2.2)");
  console.log("vs baselineèŠ‚çœ: -45.2%");
}

// è¿è¡Œæµ‹è¯•
testGasSavings();
```

### 5.2 è¿è¡ŒGasæµ‹è¯•

```bash
cd scripts/gasless-test
node test-v2.3-gas-savings.js
```

### 5.3 é¢„æœŸç»“æœå¯¹æ¯”

| ç‰ˆæœ¬ | Gasæ¶ˆè€— | vs Baseline | è¯´æ˜ |
|------|---------|-------------|------|
| Baseline v1.0 | 312,008 | - | åŸå§‹ç‰ˆæœ¬ |
| v2.2 | 181,679 | -41.8% | å½“å‰ç‰ˆæœ¬ |
| **v2.3** | **~170,879** | **-45.2%** | âœ¨ **æ–°ä¼˜åŒ–** |

**èŠ‚çœåˆ†æ**:
- SBTæ£€æŸ¥ä¼˜åŒ–: ~10,800 gas
- SafeTransferFrom: +200 gas (å®‰å…¨æ€§æå‡)
- **å‡€èŠ‚çœ**: ~10,600 gas

---

## ğŸ“Š æ­¥éª¤6: æ€§èƒ½éªŒè¯

### 6.1 Gas Profileå¯¹æ¯”

```bash
# ä½¿ç”¨forge gas-report
forge test --match-path "contracts/test/SuperPaymasterV2.t.sol" --gas-report
```

### 6.2 å®é™…é“¾ä¸Šæµ‹è¯•

è¿è¡Œå¤šç¬”gaslessäº¤æ˜“ï¼Œè®°å½•gasæ¶ˆè€—ï¼š

```bash
# æµ‹è¯•10ç¬”äº¤æ˜“
for i in {1..10}; do
  node scripts/gasless-test/test-v2.3-gas-savings.js
  sleep 5
done
```

### 6.3 ç”ŸæˆæŠ¥å‘Š

```bash
# åˆ†æäº¤æ˜“gasæ¶ˆè€—
cast receipt $TX_HASH --rpc-url $SEPOLIA_RPC_URL
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ³¨å†Œå¤±è´¥ - InsufficientStake

**åŸå› **: GTä½™é¢æˆ–stakeä¸è¶³

**è§£å†³**:
```bash
# æ£€æŸ¥GTä½™é¢
cast call 0x36b699a921Fc792119D84F1429e2C00A38c09F7f \
  "balanceOf(address)" \
  $OPERATOR_ADDRESS \
  --rpc-url $SEPOLIA_RPC_URL

# æ£€æŸ¥stakedä½™é¢
cast call 0x83f9554641B2EB8984c4DD03d27F1f75ec537D36 \
  "availableBalance(address)" \
  $OPERATOR_ADDRESS \
  --rpc-url $SEPOLIA_RPC_URL
```

### é—®é¢˜2: updateOperatorXPNTsTokenå¤±è´¥ - NotRegistered

**åŸå› **: Operatoræœªæ³¨å†Œ

**è§£å†³**: å…ˆå®Œæˆæ­¥éª¤3æ³¨å†Œoperator

### é—®é¢˜3: Gaslessäº¤æ˜“å¤±è´¥ - NoSBTFound

**åŸå› **: ç”¨æˆ·æ²¡æœ‰DEFAULT_SBT

**è§£å†³**:
```bash
# Mint SBTç»™æµ‹è¯•ç”¨æˆ·
cast send 0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C \
  "mintOrAddMembership(address,string)" \
  $USER_ADDRESS \
  "TestUser" \
  --value 100000000000000000 \
  --private-key $USER_KEY \
  --rpc-url $SEPOLIA_RPC_URL \
  --legacy
```

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ ‡

### âœ… éƒ¨ç½²æˆåŠŸ
- [ ] SuperPaymasterV2_3éƒ¨ç½²æˆåŠŸ
- [ ] VERSIONæ˜¾ç¤º"2.3.0"
- [ ] DEFAULT_SBTé…ç½®æ­£ç¡®

### âœ… Operatoræ³¨å†ŒæˆåŠŸ
- [ ] ä½¿ç”¨bPNTæ³¨å†ŒæˆåŠŸ
- [ ] getOperatorAccountè¿”å›æ­£ç¡®ä¿¡æ¯
- [ ] xPNTsToken = 0x70Da2c1B7Fcf471247Bc3B09f8927a4ab1751Ba3

### âœ… åŠŸèƒ½æµ‹è¯•æˆåŠŸ
- [ ] updateOperatorXPNTsTokenæ‰§è¡ŒæˆåŠŸ
- [ ] OperatorXPNTsTokenUpdatedäº‹ä»¶emit
- [ ] æ–°tokenåœ°å€æ›´æ–°æˆåŠŸ

### âœ… Gasä¼˜åŒ–éªŒè¯
- [ ] å®é™…gasæ¶ˆè€— < 175k
- [ ] vs v2.2èŠ‚çœ > 5%
- [ ] vs baselineèŠ‚çœ > 44%

---

## ğŸ“ æµ‹è¯•è®°å½•

### éƒ¨ç½²ä¿¡æ¯
```
éƒ¨ç½²æ—¶é—´: ___________
Paymasteråœ°å€: ___________
éƒ¨ç½²è€…: ___________
Gasæ¶ˆè€—: ___________
```

### Operatorä¿¡æ¯
```
Operatoråœ°å€: 0x411BD567E46C0781248dbB6a9211891C032885e5
xPNTsToken (bPNT): 0x70Da2c1B7Fcf471247Bc3B09f8927a4ab1751Ba3
Treasury: 0x411BD567E46C0781248dbB6a9211891C032885e5
æ³¨å†Œæ—¶é—´: ___________
```

### Gasæµ‹è¯•ç»“æœ
```
æµ‹è¯•äº¤æ˜“æ•°: ___________
å¹³å‡Gasæ¶ˆè€—: ___________
vs v2.2èŠ‚çœ: ___________
vs baselineèŠ‚çœ: ___________
```

---

**éƒ¨ç½²å®Œæˆåè¯·æ›´æ–°æ­¤æ–‡æ¡£å¹¶æäº¤åˆ°ä»“åº“ï¼**
