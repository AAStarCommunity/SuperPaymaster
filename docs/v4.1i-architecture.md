# PaymasterV4_1i Architecture Design

## Problem
需要支持两种部署方式，但避免代码重复：
1. 直接部署（构造函数）
2. 工厂部署（initialize 函数）

## Solution: Shared Base Class Architecture

```
PaymasterV4Base (abstract)
├── 所有业务逻辑
├── 无 immutable 变量（改为 internal storage）
├── 提供 _initializeV4() 内部初始化函数
└── 所有 validate, postOp, admin 函数

        ↓ 继承

PaymasterV4_1           PaymasterV4_1i
├── constructor()       ├── constructor() + _disableInitializers()
├── 调用 _initializeV4() ├── initialize() public
└── 用于直接部署        └── 用于工厂部署
```

## Benefits
✅ **单一数据源**：业务逻辑只在 `PaymasterV4Base`
✅ **易于维护**：未来修改只需改 Base
✅ **两种部署都可用**：constructor 和 initialize 并存
✅ **向后兼容**：现有 v4.1 继续工作

## Implementation Plan

### Step 1: Create `PaymasterV4Base.sol`
- Copy all logic from `PaymasterV4.sol`
- Remove immutable keywords from entryPoint, ethUsdPriceFeed, xpntsFactory
- Create internal `_initializeV4()` function
- Mark contract as `abstract`

### Step 2: Refactor `PaymasterV4_1.sol`
```solidity
contract PaymasterV4_1 is PaymasterV4Base {
    constructor(
        address _entryPoint,
        // ... other params
    ) {
        // Call internal initializer
        _initializeV4(_entryPoint, ...);
    }
}
```

### Step 3: Create `PaymasterV4_1i.sol`
```solidity
contract PaymasterV4_1i is PaymasterV4Base, Initializable {
    constructor() {
        _disableInitializers();
    }

    function initialize(
        address _entryPoint,
        // ... other params
    ) external initializer {
        // Call same internal initializer
        _initializeV4(_entryPoint, ...);
    }
}
```

## Code Changes Summary

### PaymasterV4Base.sol (NEW)
```diff
- contract PaymasterV4 is Ownable, ReentrancyGuard {
+ abstract contract PaymasterV4Base is Ownable, ReentrancyGuard {

-   IEntryPoint public immutable entryPoint;
-   AggregatorV3Interface public immutable ethUsdPriceFeed;
-   IxPNTsFactory public immutable xpntsFactory;
+   IEntryPoint public entryPoint;
+   AggregatorV3Interface public ethUsdPriceFeed;
+   IxPNTsFactory public xpntsFactory;

-   constructor(...) Ownable(msg.sender) {
-       entryPoint = IEntryPoint(_entryPoint);
-       // ...
-   }
+   function _initializeV4(...) internal {
+       entryPoint = IEntryPoint(_entryPoint);
+       // ...
+   }
}
```

### PaymasterV4_1.sol (MODIFIED)
```diff
- import { PaymasterV4 } from "./PaymasterV4.sol";
+ import { PaymasterV4Base } from "./PaymasterV4Base.sol";

- contract PaymasterV4_1 is PaymasterV4 {
+ contract PaymasterV4_1 is PaymasterV4Base {

    constructor(...)
-       PaymasterV4(_entryPoint, ...)
    {
+       _initializeV4(_entryPoint, ...);
        registry = ISuperPaymasterRegistry(_registry);
        // ...
    }
}
```

### PaymasterV4_1i.sol (NEW)
```solidity
import { PaymasterV4Base } from "./PaymasterV4Base.sol";
import { Initializable } from "@openzeppelin-v5.0.2/contracts/proxy/utils/Initializable.sol";

contract PaymasterV4_1i is PaymasterV4Base, Initializable {
    ISuperPaymasterRegistry public registry;

    constructor() {
        _disableInitializers();
    }

    function initialize(...) external initializer {
        _initializeV4(_entryPoint, ...);
        registry = ISuperPaymasterRegistry(_registry);
        // ...
    }

    function deactivateFromRegistry() external onlyOwner {
        registry.deactivate();
    }
}
```

## Migration Path

### For Existing Deployments
- ✅ 现有 `PaymasterV4_1` 合约继续工作
- ✅ 无需迁移或升级
- ✅ 新部署可选择任一方式

### For New Deployments
- **方式 1**：直接部署 `PaymasterV4_1`（高 gas）
- **方式 2**：通过工厂部署 `PaymasterV4_1i`（低 gas）

### Future Updates
- 只需修改 `PaymasterV4Base.sol`
- 两种部署方式自动继承改动
- 发布新版本：`PaymasterV4_2`, `PaymasterV4_2i`

## File Structure
```
src/paymasters/v4/
├── PaymasterV4Base.sol      (NEW - 业务逻辑基类)
├── PaymasterV4.sol           (KEEP - 向后兼容 v4)
├── PaymasterV4_1.sol         (MODIFY - 继承 Base)
└── PaymasterV4_1i.sol        (NEW - 可初始化版本)
```

## Testing Strategy
1. ✅ 测试 `PaymasterV4_1` 直接部署
2. ✅ 测试 `PaymasterV4_1i` 工厂部署
3. ✅ 验证两者功能完全一致
4. ✅ Gas 对比测试

## Deployment Steps
1. Deploy `PaymasterV4_1i` implementation to Sepolia
2. Call `PaymasterFactory.addImplementation("v4.1i", implementationAddress)`
3. Update registry frontend to use factory deployment
4. Test end-to-end flow

## Timeline
- Day 1: Create `PaymasterV4Base` and refactor
- Day 2: Test compilation and local tests
- Day 3: Deploy to Sepolia and register
- Day 4: Frontend integration
- Day 5: Documentation and review
