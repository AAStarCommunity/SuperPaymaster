# PaymasterV4_1i Implementation Plan

## Goal
Create an initializable version of PaymasterV4_1 that can be deployed via PaymasterFactory using EIP-1167 minimal proxy pattern.

## Problem
PaymasterV4 uses `immutable` variables that must be set in constructor, incompatible with proxy pattern.

## Solution
Convert immutable variables to storage variables with:
1. `initialize()` function to set initial values (proxy deployment)
2. `setter` functions (onlyOwner) to update if needed

## Changes Required

### 1. Convert Immutable to Storage Variables

**Original (PaymasterV4.sol):**
```solidity
IEntryPoint public immutable entryPoint;
AggregatorV3Interface public immutable ethUsdPriceFeed;
IxPNTsFactory public immutable xpntsFactory;
```

**New (PaymasterV4_1i.sol):**
```solidity
IEntryPoint public entryPoint;
AggregatorV3Interface public ethUsdPriceFeed;
IxPNTsFactory public xpntsFactory;
```

### 2. Add Initializable Pattern

```solidity
import { Initializable } from "@openzeppelin-v5.0.2/contracts/proxy/utils/Initializable.sol";

contract PaymasterV4_1i is Initializable, Ownable, ReentrancyGuard {
    // Constructor for implementation contract
    constructor() {
        _disableInitializers();
    }

    // Initialize for proxy instances
    function initialize(
        address _entryPoint,
        address _owner,
        address _treasury,
        address _ethUsdPriceFeed,
        uint256 _serviceFeeRate,
        uint256 _maxGasCostCap,
        uint256 _minTokenBalance,
        address _xpntsFactory,
        address _initialSBT,
        address _initialGasToken,
        address _registry
    ) external initializer {
        // Set all state variables
        entryPoint = IEntryPoint(_entryPoint);
        ethUsdPriceFeed = AggregatorV3Interface(_ethUsdPriceFeed);
        xpntsFactory = IxPNTsFactory(_xpntsFactory);
        // ... other initializations

        _transferOwnership(_owner);
    }
}
```

### 3. Add Setter Functions (Optional, for flexibility)

```solidity
/// @notice Update EntryPoint address (use with extreme caution)
/// @dev Only owner, for emergency upgrades
function setEntryPoint(address _entryPoint) external onlyOwner {
    if (_entryPoint == address(0)) revert ZeroAddress();
    entryPoint = IEntryPoint(_entryPoint);
    emit EntryPointUpdated(_entryPoint);
}

/// @notice Update price feed
function setPriceFeed(address _priceFeed) external onlyOwner {
    if (_priceFeed == address(0)) revert ZeroAddress();
    ethUsdPriceFeed = AggregatorV3Interface(_priceFeed);
    emit PriceFeedUpdated(_priceFeed);
}

/// @notice Update xPNTs factory
function setXPNTsFactory(address _factory) external onlyOwner {
    if (_factory == address(0)) revert ZeroAddress();
    xpntsFactory = IxPNTsFactory(_factory);
    emit XPNTsFactoryUpdated(_factory);
}
```

## Implementation Steps

1. ✅ Create `PaymasterV4_1i.sol` based on `PaymasterV4_1.sol`
2. ⏺ Remove `immutable` keywords from entryPoint, ethUsdPriceFeed, xpntsFactory
3. ⏺ Add `Initializable` inheritance
4. ⏺ Replace constructor with `initialize()` function
5. ⏺ Add setter functions (optional)
6. ⏺ Add implementation constructor with `_disableInitializers()`
7. ⏺ Test compilation
8. ⏺ Deploy implementation contract
9. ⏺ Register in PaymasterFactory

## Gas Implications

### Without Factory (Direct Deployment)
- Deployment cost: ~3-5M gas
- Each operator pays full cost

### With Factory (EIP-1167 Proxy)
- Implementation deployment: ~3-5M gas (one-time)
- Proxy deployment: ~100k gas (per operator)
- **Savings: 95%+ for each subsequent deployment**

## Security Considerations

1. **Initialization Safety**: Use OpenZeppelin's `Initializable` to prevent double-initialization
2. **Setter Access Control**: All setters must be `onlyOwner`
3. **Storage Collision**: EIP-1167 proxies delegate to implementation, storage layout must be identical
4. **Implementation Lock**: Call `_disableInitializers()` in implementation constructor

## Timeline

- Day 1: Create and test PaymasterV4_1i locally
- Day 2: Deploy implementation to Sepolia
- Day 3: Register in PaymasterFactory and test
- Day 4: Update frontend to use factory deployment
- Day 5: Documentation and mainnet preparation

## Version Naming

- `v4.1` - Original with constructor (direct deployment)
- `v4.1i` - Initializable version (factory deployment)
- "i" suffix = initializable/proxy-compatible
