# PaymasterV4_1i é¡¹ç›®æ€»ç»“

## ğŸ“ é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**: æ”¯æŒå·¥å‚æ¨¡å¼éƒ¨ç½² Paymasterï¼Œé€šè¿‡ EIP-1167 æœ€å°ä»£ç†å°†éƒ¨ç½² gas ä» 3-5M é™ä½åˆ° ~100kï¼ˆèŠ‚çœ 95%ï¼‰

**ç‰ˆæœ¬**: PaymasterV4.1i-v1.0.0

**å®Œæˆæ—¥æœŸ**: 2025-11-02

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¶æ„è®¾è®¡

#### é—®é¢˜
- PaymasterV4 ä½¿ç”¨ immutable å˜é‡ï¼Œä¸æ”¯æŒ initialize å‡½æ•°
- éœ€è¦åŒæ—¶æ”¯æŒç›´æ¥éƒ¨ç½²å’Œå·¥å‚éƒ¨ç½²

#### è§£å†³æ–¹æ¡ˆ
```
PaymasterV4Base (abstract)
â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘ç»Ÿä¸€ç®¡ç†
â”œâ”€â”€ immutable â†’ storage å˜é‡
â”œâ”€â”€ _initializeV4Base() å†…éƒ¨åˆå§‹åŒ–
â””â”€â”€ æ‰€æœ‰ validate/postOp å‡½æ•°

        â†“ ç»§æ‰¿

PaymasterV4_1           PaymasterV4_1i
â”œâ”€â”€ constructor()       â”œâ”€â”€ constructor() + _disableInitializers()
â”œâ”€â”€ ç›´æ¥éƒ¨ç½²            â”œâ”€â”€ initialize() public initializer
â””â”€â”€ ~3-5M gas          â””â”€â”€ ~100k gas (å·¥å‚ä»£ç†)
```

#### æ ¸å¿ƒå˜æ›´
**ä¸‰ä¸ª immutable å˜é‡æ”¹ä¸º storage**ï¼š
1. `IEntryPoint public entryPoint`
2. `AggregatorV3Interface public ethUsdPriceFeed`
3. `IxPNTsFactory public xpntsFactory`

---

### 2. åˆçº¦æ–‡ä»¶

#### æ–°å»ºæ–‡ä»¶
1. **src/paymasters/v4/PaymasterV4Base.sol**
   - æŠ½è±¡åŸºç±»ï¼ŒåŒ…å«æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
   - ç‰ˆæœ¬ï¼šPaymasterV4Base-v1.0.0

2. **src/paymasters/v4/PaymasterV4_1i.sol**
   - å¯åˆå§‹åŒ–ç‰ˆæœ¬
   - ç»§æ‰¿ `PaymasterV4Base` + `Initializable`
   - ç‰ˆæœ¬ï¼šPaymasterV4.1i-v1.0.0

#### ä¿®æ”¹æ–‡ä»¶
3. **src/paymasters/v4/PaymasterV4_1.sol**
   - é‡æ„ä¸ºç»§æ‰¿ PaymasterV4Base
   - ä¿æŒå‘åå…¼å®¹
   - ç‰ˆæœ¬ï¼šPaymasterV4.1-Registry-v1.1.0

---

### 3. éƒ¨ç½²è„šæœ¬

#### script/DeployPaymasterV4_1i.s.sol
- éƒ¨ç½²å®ç°åˆçº¦
- ä½¿ç”¨ Blockscout éªŒè¯å™¨
- è‡ªåŠ¨ç”Ÿæˆéƒ¨ç½²è®°å½•

#### script/TestPaymasterV4_1i_Factory.s.sol
- å®Œæ•´æµ‹è¯•å·¥å‚éƒ¨ç½²æµç¨‹
- éªŒè¯åˆå§‹åŒ–å‚æ•°
- ç¡®è®¤åŠŸèƒ½æ­£å¸¸

---

### 4. æµ‹è¯•ä¿®å¤

#### ç‰ˆæœ¬å·æµ‹è¯•
- **é—®é¢˜**: MySBT v2.4.0 æµ‹è¯•æœŸæœ› 240ï¼Œå®é™…æ˜¯ 20400
- **ä¿®å¤**: `assertEq(mysbt.VERSION_CODE(), 20400)`
- **ç»“æœ**: æ‰€æœ‰æµ‹è¯•é€šè¿‡ (206 passed, 0 failed)

#### ç‰ˆæœ¬å·è§„èŒƒ
```solidity
function version() external pure returns (string memory);
uint256 public constant VERSION_CODE = XXYYZZ;  // X.Y.Z * 10000
```

---

### 5. æ–‡æ¡£

1. **docs/v4.1i-architecture.md** - æ¶æ„è®¾è®¡æ–‡æ¡£
2. **docs/v4.1i-implementation-plan.md** - å®ç°è®¡åˆ’
3. **docs/v4.1i-deployment-plan.md** - å®Œæ•´éƒ¨ç½²è®¡åˆ’
4. **docs/DEPLOY_V4_1i.md** - è¯¦ç»†éƒ¨ç½²æŒ‡å—
5. **docs/DEPLOY_COMMANDS.md** - å¿«é€Ÿå‘½ä»¤å‚è€ƒ
6. **docs/v4.1i-SUMMARY.md** - æœ¬æ€»ç»“æ–‡æ¡£

---

## ğŸ”‘ å…³é”®é—®é¢˜å’Œè§£ç­”

### Q1: æ˜¯å¦éœ€è¦é‡æ–°éƒ¨ç½² PaymasterFactoryï¼Ÿ
**ç­”**: âŒ ä¸éœ€è¦

**åŸå› **:
- ç°æœ‰ Factory v1.0.0 æ”¯æŒç‰ˆæœ¬ç®¡ç†
- é€šè¿‡ `addImplementation("v4.1i", address)` æ·»åŠ æ–°ç‰ˆæœ¬
- å‘åå…¼å®¹ï¼Œä¸å½±å“å·²éƒ¨ç½²å®ä¾‹

---

### Q2: Factory Owner å¯ä»¥è½¬è®©ç»™ Safe å¤šç­¾å—ï¼Ÿ
**ç­”**: âœ… å®Œå…¨æ”¯æŒ

**æ–¹æ³•**:
```solidity
factory.transferOwnership(safeAddress);
```

**å¥½å¤„**:
- å¤šç­¾ç®¡ç† addImplementation æƒé™
- æé«˜å®‰å…¨æ€§
- å»ä¸­å¿ƒåŒ–æ²»ç†

---

### Q3: å®ç°åˆçº¦åœ°å€ä¸å¯æ›´æ”¹æ€ä¹ˆåŠï¼Ÿ
**ç­”**: âœ… å¯ä»¥æ·»åŠ æ–°ç‰ˆæœ¬

**è¯´æ˜**:
- å·²æ³¨å†Œç‰ˆæœ¬åœ°å€ä¸å¯ä¿®æ”¹ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
- å¯æ·»åŠ æ–°ç‰ˆæœ¬ï¼š`v4.1i-v1.0.1`, `v4.2i`
- æ–°ç”¨æˆ·ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼Œæ—§ä»£ç†ç»§ç»­è¿è¡Œ

---

### Q4: EIP-1167 ä»£ç†ä¸å¯å‡çº§æ€ä¹ˆåŠï¼Ÿ
**ç­”**: âœ… åˆçº¦ç®€å•ï¼Œå‡çº§éœ€æ±‚å°‘

**ç­–ç•¥**:
- v4 ä¸šåŠ¡é€»è¾‘ç¨³å®š
- æ–°ç‰ˆæœ¬é€šè¿‡ Factory éƒ¨ç½²
- æ—§å®ä¾‹ç»§ç»­è¿è¡Œï¼Œä¸å½±å“

---

## ğŸ“Š Gas èŠ‚çœå¯¹æ¯”

| éƒ¨ç½²æ–¹å¼ | Gas æ¶ˆè€— | æˆæœ¬ (20 Gwei) | èŠ‚çœ |
|---------|---------|---------------|------|
| ç›´æ¥éƒ¨ç½² v4.1 | ~3-5M | ~0.06-0.1 ETH | - |
| å®ç°åˆçº¦ (ä¸€æ¬¡æ€§) | ~3-5M | ~0.06-0.1 ETH | - |
| Factory æ³¨å†Œ (ä¸€æ¬¡æ€§) | ~50k | ~0.001 ETH | - |
| **Factory åˆ›å»ºä»£ç†** | **~100k** | **~0.002 ETH** | **95%** |

**ç»“è®º**: ç¬¬äºŒä¸ªå®ä¾‹å¼€å§‹ï¼Œæ¯ä¸ªèŠ‚çœ 95% gasï¼

---

## ğŸ—ï¸ å·²éƒ¨ç½²åˆçº¦ï¼ˆSepoliaï¼‰

### æ ¸å¿ƒåŸºç¡€è®¾æ–½
- **Factory**: `0x65Cf6C4ab3d40f3C919b6F3CADC09Efb72817920`
- **Registry**: `0xb6286F53d8ff25eF99e6a43b2907B8e6BD0f019A`
- **xPNTsFactory**: `0x9dD72cB42427fC9F7Bf0c949DB7def51ef29D6Bd`
- **EntryPoint v0.7**: `0x0000000071727De22E5E9d8BAf0edAc6f37da032`
- **ETH/USD Feed**: `0x694AA1769357215DE4FAC081bf1f309aDC325306`

### PaymasterV4_1i (å¾…éƒ¨ç½²)
- **Implementation**: TBD
- **Test Proxy**: TBD

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. âº **éƒ¨ç½²å®ç°åˆçº¦**
   ```bash
   forge script script/DeployPaymasterV4_1i.s.sol:DeployPaymasterV4_1i \
     --rpc-url $SEPOLIA_RPC_URL --broadcast --verify \
     --verifier blockscout \
     --verifier-url https://eth-sepolia.blockscout.com/api/ -vvvv
   ```

2. âº **æ³¨å†Œåˆ° Factory**
   ```bash
   cast send $PAYMASTER_FACTORY \
     "addImplementation(string,address)" "v4.1i" $V4_1i_IMPLEMENTATION \
     --rpc-url $SEPOLIA_RPC_URL --private-key $PRIVATE_KEY
   ```

3. âº **æµ‹è¯•å·¥å‚éƒ¨ç½²**
   ```bash
   forge script script/TestPaymasterV4_1i_Factory.s.sol:TestPaymasterV4_1i_Factory \
     --rpc-url $SEPOLIA_RPC_URL --broadcast -vvvv
   ```

### åç»­è®¡åˆ’
4. âº æ›´æ–° shared-config åŒ…å«æ–°åœ°å€
5. âº ä¿®æ”¹ registry å‰ç«¯ä½¿ç”¨ Factory
6. âº å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•
7. âº ä¸»ç½‘éƒ¨ç½²å‡†å¤‡

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å·²å®ç°
- âœ… å®ç°åˆçº¦ç¦æ­¢åˆå§‹åŒ–ï¼ˆ`_disableInitializers()`ï¼‰
- âœ… ä»£ç†åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡ï¼ˆ`initializer` modifierï¼‰
- âœ… Ownable æƒé™ä¿æŠ¤
- âœ… ReentrancyGuard é‡å…¥ä¿æŠ¤
- âœ… EntryPoint v0.7 é›†æˆ

### å»ºè®®
- âš ï¸ Factory owner å»ºè®®è½¬ç»™ Safe å¤šç­¾
- âš ï¸ Paymaster owner å»ºè®®ä½¿ç”¨ Safe
- âš ï¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¿›è¡Œå®¡è®¡
- âš ï¸ å…³é”®æ“ä½œè®¾ç½®æ—¶é—´é”

---

## ğŸ“š æŠ€æœ¯æ ˆ

### å¼€å‘å·¥å…·
- **Foundry**: v0.8.26
- **Solidity**: ^0.8.26
- **OpenZeppelin**: v5.0.2

### æ ¸å¿ƒä¾èµ–
- **@account-abstraction-v7**: EntryPoint æ¥å£
- **@chainlink**: ä»·æ ¼é¢„è¨€æœº
- **EIP-1167**: æœ€å°ä»£ç†æ ‡å‡†

### éªŒè¯å·¥å…·
- **Blockscout**: åˆçº¦éªŒè¯ï¼ˆè‡ªåŠ¨åŒæ­¥ Etherscanï¼‰

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### 1. Factory Pattern
- EIP-1167 æœ€å°ä»£ç†å®ç°
- OpenZeppelin Clones åº“ä½¿ç”¨
- initialize vs constructor

### 2. ç‰ˆæœ¬ç®¡ç†
- å®ç°ç‰ˆæœ¬å­—ç¬¦ä¸²ç®¡ç†
- æ•°å­—ç‰ˆæœ¬ç ï¼ˆX.Y.Z * 10000ï¼‰
- å‘åå…¼å®¹ç­–ç•¥

### 3. å¤šç­¾æ²»ç†
- Safe multisig é›†æˆ
- Ownable æƒé™è½¬è®©
- å»ä¸­å¿ƒåŒ–æ²»ç†

---

## ğŸ“ è”ç³»æ–¹å¼

- **é¡¹ç›®**: SuperPaymaster
- **ç»„ç»‡**: AAStar Community
- **GitHub**: https://github.com/AAStarCommunity
- **Discord**: https://discord.gg/aastar

---

## ğŸ“„ è®¸å¯è¯

MIT License

---

**æœ€åæ›´æ–°**: 2025-11-02
**ä½œè€…**: Claude + AAStar Team
